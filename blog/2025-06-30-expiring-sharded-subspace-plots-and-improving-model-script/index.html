<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Expiring Sharded Subspace Plots and improving model script &#183; Project Abundance</title><meta name=title content="Expiring Sharded Subspace Plots and improving model script &#183; Project Abundance"><meta name=description content="Commiting sectors to a range of history sizes to maintain Subspace's plot expiration logic"><meta name=keywords content="status-update,consensus,"><link rel=canonical href=https://abundance.build/blog/2025-06-30-expiring-sharded-subspace-plots-and-improving-model-script/><link type=text/css rel=stylesheet href=/css/main.bundle.min.fd951ea54edeca1b6b08c8bbf3c93c284de4c78daf63a71d8016939775734cf68700f1662ed31d870100c676cbe1f65d150635cf368b874c49fc75147bcb04a9.css integrity="sha512-/ZUepU7eyhtrCMi788k8KE3kx42vY6cdgBaTl3VzTPaHAPFmLtMdhwEAxnbL4fZdFQY1zzaLh0xJ/HUUe8sEqQ=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.e4b2d9aece2aa7a740c3ee7a0efc5acf56b204868ab0fb5bba9be32aed1cd0c9262979d98050759068d58144297f74b12ed05b5173cf2df2e6c097a066b984a8.js integrity="sha512-5LLZrs4qp6dAw+56Dvxaz1ayBIaKsPtbupvjKu0c0MkmKXnZgFB1kGjVgUQpf3SxLtBbUXPPLfLmwJegZrmEqA==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://abundance.build/blog/2025-06-30-expiring-sharded-subspace-plots-and-improving-model-script/"><meta property="og:site_name" content="Project Abundance"><meta property="og:title" content="Expiring Sharded Subspace Plots and improving model script"><meta property="og:description" content="Commiting sectors to a range of history sizes to maintain Subspace's plot expiration logic"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-06-30T00:00:00+00:00"><meta property="article:modified_time" content="2025-06-30T00:00:00+00:00"><meta property="article:tag" content="status-update"><meta property="article:tag" content="consensus"><meta name=twitter:card content="summary"><meta name=twitter:title content="Expiring Sharded Subspace Plots and improving model script"><meta name=twitter:description content="Commiting sectors to a range of history sizes to maintain Subspace's plot expiration logic"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Blog","name":"Expiring Sharded Subspace Plots and improving model script","headline":"Expiring Sharded Subspace Plots and improving model script","description":"Commiting sectors to a range of history sizes to maintain Subspace\u0027s plot expiration logic","abstract":"\u003cp\u003eAs mentioned on last week\u0026rsquo;s status update, one of the key pieces that I was missing to have the\ndetailed operation of plot membership allocation was the impact of sector expiration on the\nprotocol. By having a unique plot identifier, we are able to uniquely link sectors to plots, but\nthese sectors need to expire in a way that does not require farmers to re-plot while archiving the\nmost recent history. Fortunately, we can leverage the current expiration mechanism of the Subspace\nprotocol, and build a layer on top of it to adapt it to the sharded version while maintaining the\noriginal guarantees in terms of plot expiration, sector re-plotting, and history archiving.\u003c\/p\u003e","inLanguage":"en","url":"https:\/\/abundance.build\/blog\/2025-06-30-expiring-sharded-subspace-plots-and-improving-model-script\/","author":{"@type":"Person","name":""},"copyrightYear":"2025","dateCreated":"2025-06-30T00:00:00\u002b00:00","datePublished":"2025-06-30T00:00:00\u002b00:00","dateModified":"2025-06-30T00:00:00\u002b00:00","keywords":["status-update","consensus"],"mainEntityOfPage":"true","wordCount":"1548"}]</script><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">Project Abundance</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Expiring Sharded Subspace Plots and improving model script</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-06-30T00:00:00+00:00>30 June 2025</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">8 mins</span><span class="px-2 text-primary-500">&#183;</span>
<span class=mb-[2px]><a href=https://github.com/nazar-pc/abundance/tree/main/website/main/content/blog/2025/2025-06-30-expiring-sharded-subspace-plots-and-improving-model-script.md class="text-lg hover:text-primary-500" rel="noopener noreferrer" target=_blank title="Edit content"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg height="1em" viewBox="0 0 512 512"><path fill="currentColor" d="M441 58.9 453.1 71c9.4 9.4 9.4 24.6.0 33.9L424 134.1 377.9 88 407 58.9c9.4-9.4 24.6-9.4 33.9.0zM209.8 256.2 344 121.9 390.1 168 255.8 302.2c-2.9 2.9-6.5 5-10.4 6.1L186.9 325l16.7-58.5c1.1-3.9 3.2-7.5 6.1-10.4zM373.1 25 175.8 222.2c-8.7 8.7-15 19.4-18.3 31.1l-28.6 1e2c-2.4 8.4-.1 17.4 6.1 23.6s15.2 8.5 23.6 6.1l1e2-28.6c11.8-3.4 22.5-9.7 31.1-18.3L487 138.9c28.1-28.1 28.1-73.7.0-101.8L474.9 25C446.8-3.1 401.2-3.1 373.1 25zM88 64C39.4 64 0 103.4.0 152V424c0 48.6 39.4 88 88 88H360c48.6.0 88-39.4 88-88V312c0-13.3-10.7-24-24-24s-24 10.7-24 24V424c0 22.1-17.9 40-40 40H88c-22.1.0-40-17.9-40-40V152c0-22.1 17.9-40 40-40H2e2c13.3.0 24-10.7 24-24s-10.7-24-24-24H88z"/></svg></span></span></a></span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] mr-2" href=/tags/status-update/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">status-update
</span></span></a><a class="relative mt-[0.5rem] mr-2" href=/tags/consensus/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">consensus</span></span></a></div></div><div class="flex author"><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class="flex author author-extra mt-4"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 src=/f1c66b8937bd6938a029cea2fdb21d9b_11706180554726321909_hu_1fd0f9097b9cc146.png><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><a href=https://abundance.build/authors/adlrocha/ class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Alfonso de la Rocha</a><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://linkedin.com/in/adlrocha target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://x.com/adlrocha target=_blank aria-label=X-Twitter rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span></span></a>
<a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/adlrocha target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:me@adlrocha.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>As mentioned on last week&rsquo;s status update, one of the key pieces that I was missing to have the
detailed operation of plot membership allocation was the impact of sector expiration on the
protocol. By having a unique plot identifier, we are able to uniquely link sectors to plots, but
these sectors need to expire in a way that does not require farmers to re-plot while archiving the
most recent history. Fortunately, we can leverage the current expiration mechanism of the Subspace
protocol, and build a layer on top of it to adapt it to the sharded version while maintaining the
original guarantees in terms of plot expiration, sector re-plotting, and history archiving.</p><h2 class="relative group">Sharded Subspace Plot Expiration Protocol<div id=sharded-subspace-plot-expiration-protocol class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#sharded-subspace-plot-expiration-protocol aria-label=Anchor>#</a></span></h2><h3 class="relative group">Overview<div id=overview class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#overview aria-label=Anchor>#</a></span></h3><p>Before I start with the description of the protocol, let me remind you what are the core properties
that we wanted the protocol to have:</p><ol><li><strong>Unique Plot IDs:</strong> <code>plot_id</code> is unique and stable. This is key for the protocol, as this ID
will be used to allocate space into shards.</li><li><strong>No Bias through <code>history_size</code>:</strong> Farmers must not be able to bias the shard allocation for
their convenience. They may be able to achieve this by creating sectors with the same sector ID
that can be committed to any <code>history_size</code>. This can be prevented by limiting the range of
history sizes that plot sectors can be committed to. Thus, farmers are not allowed to manipulate
shard allocation by assigning to a plot the most convenient sector at each time.</li><li><strong>Load-Balanced Archiving (New History):</strong> As new history is archived, it gets plotted shortly
after by sufficient number of farmers without large re-plotting events.</li><li><strong>Detect Expiration and Validity:</strong> Plots, sectors and blocks include all the information needed
to verify their validity, plot assignment to a shard, sector belonging to the plot, and
expiration.</li><li><strong>No Excessive Re-plotting:</strong> Keep re-plotting burden similar to original Subspace.</li></ol><h3 class="relative group">Committing sectors to history ranges<div id=committing-sectors-to-history-ranges class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#committing-sectors-to-history-ranges aria-label=Anchor>#</a></span></h3><p>The core idea for sector expiration is the following: instead of letting farmers commit their
sectors to any history size, they are bound to commit them to a range of history sizes determined by
the plot the sector is linked to. This way, we limit the range of history sizes that a sector can be
committed to, and hence limited the number of parallel sectors with the same <code>plot_id</code> and different
committed history sizes that can be created. This is implemented as a &ldquo;self-evolving plot commitment
range&rdquo; that grows as the blockchain grows on top of the existing mechanism for sector expiration.
Thus, we maintain all the properties of the original Subspace protocol, while adapting it to the
needs of the sharded version. This allows us to also learn an apply the heuristics from the live
Subspace network.</p><p>The high-level operation of the protocol is as follows:</p><ul><li>When creating a new plot, farmers need to choose a random nonce for their plot. This nonce
determines the specific ID of the plot and will influence the history range that the plot&rsquo;s
sectors can commit to. As a reminder, plots identities are inferred from the public key hash of
the farmer, and the random nonce they choose:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=n>plot_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hash</span><span class=p>(</span><span class=n>public_key_hash</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>nonce</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><ul><li>When creating new sectors for a plot, farmers will choose any valid history size within the plot&rsquo;s
current range. Piece selection is based on the sector&rsquo;s specific history size, and expiration
follows the same logic as the original Subspace protocol. Finally, the sector ID is derived from
the plot ID, sector index, and committed history size:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=n>sector_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>keyed_hash</span><span class=p>(</span><span class=n>plot_id</span><span class=p>,</span><span class=w> </span><span class=n>sector_index</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>committed_history_size</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><ul><li>We determine a protocol parameter <code>BASE_WINDOW_SIZE</code> that determines the size of the <code>BASE_RANGE</code>.
This <code>BASE_RANGE</code> determines the baseline history range for all plots, i.e. the reference range
that will be used as input to infer a plot&rsquo;s effective range. The <code>BASE_RANGE</code> determines the
initial size of history sizes that plots can commit to initially. The effective range that a plot
can commit to at a a specific point in time is determined by a transformation of the <code>BASE_RANGE</code>
based on the plot&rsquo;s nonce and the current history size. As the history of the chain grows, this is
expanded accordingly so it can fit new history sizes. The following image belongs to a
<a href=2025-06-30-sector-expirationange-evolution-visual.html>simple visualisation tool</a> that an
LLM has built for me to visualise how the base range and effective range of a plot behaves as the
history of the chain grows:</li></ul><p align=center><img alt="Range evolution visualisation" src=range_visualisation.png></p><ul><li>Sectors expire as they are used to in current Subspace protocol, so even if the effective range
for plots grow, sectors committed to old history sizes will be alreaedy expired (or close to
expire) still limiting the number of history sizes that sectors can commit to at a given time.
This is key to ensure that farmers do not need to re-plot their sectors as the history grows, and
that they can archive the most recent history without having to re-plot, maintaining all the nice
properties for sector expiration of the original Subspace protocol.</li></ul><h3 class="relative group">Putting all pieces together<div id=putting-all-pieces-together class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#putting-all-pieces-together aria-label=Anchor>#</a></span></h3><p>With this, we have all that we needed to finally implement farming in shards:</p><ul><li>Plot IDs are unique and stable, allowing us to allocate space into shards.</li><li>Sectors are committed to a range of history sizes determined by the plot ID, preventing farmers
from gaming shard allocation.</li><li>Piece selection, sector expiration stay unchanged.</li><li>Farming stays mostly unchanged, apart from the additional information required to verify that the
chunk for the piece in the solution range belongs to a sector bound to a plot currently assigned
to the shard.</li></ul><p>This is how the verification logic for a solution in a shard would look like:</p><ul><li>Standard Subspace Verification (Unchanged): First, perform all existing Subspace checks</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>// Verify piece offset is valid
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span><span class=w> </span><span class=n>piece_offset</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>max_pieces_in_sector</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=s>&#34;Invalid piece offset&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Check sector expiration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span><span class=w> </span><span class=n>sector_is_expired</span><span class=p>(</span><span class=n>sector_id</span><span class=p>,</span><span class=w> </span><span class=n>current_history_size</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=s>&#34;Sector has expired&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Verify the piece is part of blockchain history
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=n>verify_piece_inclusion</span><span class=p>(</span><span class=n>piece</span><span class=p>,</span><span class=w> </span><span class=n>segment_root</span><span class=p>,</span><span class=w> </span><span class=n>proof</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=s>&#34;Invalid piece proof&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>Plot Identity Verification: Verify that the solution comes from a valid plot:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>// Step 2.1: Compute expected plot ID from farmer&#39;s public key and nonce
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>expected_plot_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hash</span><span class=p>(</span><span class=n>farmer_public_key</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>plot_nonce</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Step 2.2: Verify the sector was created with this plot ID
</span></span></span><span class=line><span class=cl><span class=c1>// The sector_id should incorporate the plot_id
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=n>sector_belongs_to_plot</span><span class=p>(</span><span class=n>sector_id</span><span class=p>,</span><span class=w> </span><span class=n>expected_plot_id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=s>&#34;Sector doesn&#39;t belong to claimed plot&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>Range Validation: Ensure the sector&rsquo;s committed history size is within the plot&rsquo;s valid range:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>// Step 3.1: Calculate the plot&#39;s base range from its nonce
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>window_level</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>current_history_size</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=no>BASE_WINDOW_SIZE</span><span class=p>).</span><span class=n>ilog2</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>window_size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>BASE_WINDOW_SIZE</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=n>window_level</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>nonce_in_window</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>plot_nonce</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=no>NONCES_PER_WINDOW</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>min_history</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>window_size</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>nonce_in_window</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=no>NONCES_PER_WINDOW</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>GENESIS_nonce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>max_history</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>window_size</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>nonce_in_window</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=no>NONCES_PER_WINDOW</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>GENESIS_nonce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Step 3.2: Calculate effective range (extends with blockchain growth)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>effective_max_history</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>max</span><span class=p>(</span><span class=n>max_history</span><span class=p>,</span><span class=w> </span><span class=n>current_history_size</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Step 3.3: Verify sector&#39;s history size is within range
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span><span class=w> </span><span class=n>sector_history_size</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>min_history</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>sector_history_size</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>effective_max_history</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=s>&#34;Sector history size outside plot&#39;s valid range&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>Shard Assignment Verification: Confirm the plot is assigned to the current shard:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>// Step 4.1: Determine which shard this plot belongs to
</span></span></span><span class=line><span class=cl><span class=c1>// Construct VRF input using the same format as allocation
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>vrf_input</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>plot_id</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>randomness</span><span class=p>;</span><span class=w>  </span><span class=c1>// Changed from min_history to randomness
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>vrf_signature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>plot_vrf_signature</span><span class=p>;</span><span class=w>  </span><span class=c1>// From block seal
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Verify the VRF signature
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=n>verify_vrf</span><span class=p>(</span><span class=n>plot_public_key</span><span class=p>,</span><span class=w> </span><span class=n>vrf_input</span><span class=p>,</span><span class=w> </span><span class=n>vrf_signature</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=s>&#34;Invalid VRF signature&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Calculate expected shard assignment using same logic as allocation
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>expected_shard_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vrf_output_to_shard</span><span class=p>(</span><span class=n>vrf_signature</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=no>NUM_SHARDS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Verify the claimed shard_id matches expected
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span><span class=w> </span><span class=n>claimed_shard_id</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>expected_shard_id</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=s>&#34;Shard assignment mismatch&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>To perform sharded verification, clients need:</p><ul><li><p>From the Solution</p><ul><li><code>farmer_public_key</code>: The farmer&rsquo;s identity</li><li><code>plot_nonce</code>: The nonce chosen when creating the plot</li><li><code>sector_index</code>: Which sector within the plot</li><li><code>sector_history_size</code>: The history size this sector committed to</li><li><code>piece_offset</code>: Which piece within the sector</li><li>Standard Subspace proofs (piece inclusion, etc.)</li></ul></li><li><p>From the Block Header and the network</p><ul><li><code>current_history_size</code>: Current blockchain history size</li><li><code>current_shard_id</code>: Which shard is performing verification</li><li>Protocol constants (BASE_WINDOW_SIZE, NUM_SHARDS, etc.)</li></ul></li></ul><h3 class="relative group">A script to tinker with and next steps!<div id=a-script-to-tinker-with-and-next-steps class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#a-script-to-tinker-with-and-next-steps aria-label=Anchor>#</a></span></h3><p>This week I&rsquo;ve also been spending some time implementing all the formal models from the last few
updates into a Python script that allow us to tinker with the protocol and see how it impacts its
security and correctness. So far the results are promising, but it still needs a few iterations to
double-check that the model makes sense and that the protocol is sound. I am also working on try to
extensively document the script so others can pick it up and play with it and/or point out potential
mistakes.</p><p align=center><img alt="Screenshot from protocol modelling script" src=script_screenshot.png></p><p>With this in mind, this week I will be focusing on:</p><ul><li>Mapping all the sector expiration and history range logic into pseudocode so Nazar can start
implementing the validation logic that will in itself start enabling adapting plotting and farming
to shards.</li><li>Exploring the implementation of a simple simulator that allows us to simulate the protocol and its
properties, so we can start reasoning about different parameters and its specific sub-protocols
more concretely than the current Python script.</li></ul><p>Let&rsquo;s see how far we get this week! I am excited to see how this will evolve and how we can start
building the foundation for a more robust and scalable protocol. As always, reach out if you have
any questions, suggestions, or feedback. Until next week!</p></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_blog/2025/2025-06-30-expiring-sharded-subspace-plots-and-improving-model-script.md data-oid-likes=likes_blog/2025/2025-06-30-expiring-sharded-subspace-plots-and-improving-model-script.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/blog/2025-06-23-block-processing-progress/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Block processing progress</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-06-23T00:00:00+00:00>23 June 2025</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/blog/2025-07-02-adventures-with-rust-gpu/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Adventures with rust-gpu</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-07-02T00:00:00+00:00>2 July 2025</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0 z-10"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400"><a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel="license noopener noreferrer">CC0 1.0 Universal</a></p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer></div></body></html>