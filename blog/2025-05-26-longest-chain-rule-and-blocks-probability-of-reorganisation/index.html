<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Longest-chain rule and blocks probability of reorganisation &#183; Project Abundance</title><meta name=title content="Longest-chain rule and blocks probability of reorganisation &#183; Project Abundance"><meta name=description content="How relying on the longest-chain rule can fit all protocol mechanics together"><meta name=keywords content="status-update,consensus,"><link rel=canonical href=https://abundance.build/blog/2025-05-26-longest-chain-rule-and-blocks-probability-of-reorganisation/><link type=text/css rel=stylesheet href=/css/main.bundle.min.fd951ea54edeca1b6b08c8bbf3c93c284de4c78daf63a71d8016939775734cf68700f1662ed31d870100c676cbe1f65d150635cf368b874c49fc75147bcb04a9.css integrity="sha512-/ZUepU7eyhtrCMi788k8KE3kx42vY6cdgBaTl3VzTPaHAPFmLtMdhwEAxnbL4fZdFQY1zzaLh0xJ/HUUe8sEqQ=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.e4b2d9aece2aa7a740c3ee7a0efc5acf56b204868ab0fb5bba9be32aed1cd0c9262979d98050759068d58144297f74b12ed05b5173cf2df2e6c097a066b984a8.js integrity="sha512-5LLZrs4qp6dAw+56Dvxaz1ayBIaKsPtbupvjKu0c0MkmKXnZgFB1kGjVgUQpf3SxLtBbUXPPLfLmwJegZrmEqA==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://abundance.build/blog/2025-05-26-longest-chain-rule-and-blocks-probability-of-reorganisation/"><meta property="og:site_name" content="Project Abundance"><meta property="og:title" content="Longest-chain rule and blocks probability of reorganisation"><meta property="og:description" content="How relying on the longest-chain rule can fit all protocol mechanics together"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-05-26T00:00:00+00:00"><meta property="article:modified_time" content="2025-05-26T00:00:00+00:00"><meta property="article:tag" content="status-update"><meta property="article:tag" content="consensus"><meta name=twitter:card content="summary"><meta name=twitter:title content="Longest-chain rule and blocks probability of reorganisation"><meta name=twitter:description content="How relying on the longest-chain rule can fit all protocol mechanics together"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Blog","name":"Longest-chain rule and blocks probability of reorganisation","headline":"Longest-chain rule and blocks probability of reorganisation","description":"How relying on the longest-chain rule can fit all protocol mechanics together","abstract":"\u003cp\u003eI started the week thinking about the mechanics of shard segment commitment into the global history\nof the beacon chain. If you recall from previous updates, we already had a pretty good idea of how\nthe information about child shard segments flow up to the beacon chain, but there were still a few\nquestions that were really bugging me.\u003c\/p\u003e","inLanguage":"en","url":"https:\/\/abundance.build\/blog\/2025-05-26-longest-chain-rule-and-blocks-probability-of-reorganisation\/","author":{"@type":"Person","name":""},"copyrightYear":"2025","dateCreated":"2025-05-26T00:00:00\u002b00:00","datePublished":"2025-05-26T00:00:00\u002b00:00","dateModified":"2025-05-26T00:00:00\u002b00:00","keywords":["status-update","consensus"],"mainEntityOfPage":"true","wordCount":"1702"}]</script><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">Project Abundance</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Longest-chain rule and blocks probability of reorganisation</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-05-26T00:00:00+00:00>26 May 2025</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">8 mins</span><span class="px-2 text-primary-500">&#183;</span>
<span class=mb-[2px]><a href=https://github.com/nazar-pc/abundance/tree/main/website/main/content/blog/2025/2025-05-26-longest-chain-rule-and-blocks-probability-of-reorganisation.md class="text-lg hover:text-primary-500" rel="noopener noreferrer" target=_blank title="Edit content"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg height="1em" viewBox="0 0 512 512"><path fill="currentColor" d="M441 58.9 453.1 71c9.4 9.4 9.4 24.6.0 33.9L424 134.1 377.9 88 407 58.9c9.4-9.4 24.6-9.4 33.9.0zM209.8 256.2 344 121.9 390.1 168 255.8 302.2c-2.9 2.9-6.5 5-10.4 6.1L186.9 325l16.7-58.5c1.1-3.9 3.2-7.5 6.1-10.4zM373.1 25 175.8 222.2c-8.7 8.7-15 19.4-18.3 31.1l-28.6 1e2c-2.4 8.4-.1 17.4 6.1 23.6s15.2 8.5 23.6 6.1l1e2-28.6c11.8-3.4 22.5-9.7 31.1-18.3L487 138.9c28.1-28.1 28.1-73.7.0-101.8L474.9 25C446.8-3.1 401.2-3.1 373.1 25zM88 64C39.4 64 0 103.4.0 152V424c0 48.6 39.4 88 88 88H360c48.6.0 88-39.4 88-88V312c0-13.3-10.7-24-24-24s-24 10.7-24 24V424c0 22.1-17.9 40-40 40H88c-22.1.0-40-17.9-40-40V152c0-22.1 17.9-40 40-40H2e2c13.3.0 24-10.7 24-24s-10.7-24-24-24H88z"/></svg></span></span></a></span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] mr-2" href=/tags/status-update/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">status-update
</span></span></a><a class="relative mt-[0.5rem] mr-2" href=/tags/consensus/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">consensus</span></span></a></div></div><div class="flex author"><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class="flex author author-extra mt-4"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 src=/f1c66b8937bd6938a029cea2fdb21d9b_11706180554726321909_hu_1fd0f9097b9cc146.png><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><a href=https://abundance.build/authors/adlrocha/ class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Alfonso de la Rocha</a><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://linkedin.com/in/adlrocha target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://x.com/adlrocha target=_blank aria-label=X-Twitter rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span></span></a>
<a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/adlrocha target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:me@adlrocha.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>I started the week thinking about the mechanics of shard segment commitment into the global history
of the beacon chain. If you recall from previous updates, we already had a pretty good idea of how
the information about child shard segments flow up to the beacon chain, but there were still a few
questions that were really bugging me.</p><p>Mainly:</p><ul><li>When a segment is committed in the beacon chain, how can we inform the corresponding child shard
that the segment has been added to the global history and assigned a global piece index?</li><li>How can we ensure that a segment is <em>&ldquo;final&rdquo;</em> with a really high probability before committing it
to the global history?</li><li>How do block re-organisations in the beacon chain, or lower level shards, affect the flow
information up the hierarchy?</li><li>How do we ensure that the information about the shard segments is available and verifiable, and
that segments are encoded correctly and include the set of blocks that is supposed to have?</li></ul><p>Thinking about all these questions led to a realisation that, while obvious in hindsight, is going
to really simplify the design of the protocol and its security analysis moving forward: we can embed
all the core protocol verifications and mechanics into the longest-chain rule (including block shard
submissions, segment verification and commitments, chain re-organisations, challenges and data
availability checks).</p><p>With this, all chains in the hierarchy are able to deterministically reason about the validity of
the information included in blocks without having to rely on external mechanisms like fraud proofs
or a dedicated data availability chain (and this is why the design of Bitcoin is so elegant!).</p><h2 class="relative group">Impact of chain re-organisations in shard block submissions<div id=impact-of-chain-re-organisations-in-shard-block-submissions class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#impact-of-chain-re-organisations-in-shard-block-submissions aria-label=Anchor>#</a></span></h2><p>Let&rsquo;s illustrate how this new realisation of leveraging the longest-chain for all core protocol
mechanics come to play starting with how it affects the shard block submission process, which is
going to be the main data structure impacted by chain reorganisations. See the image below for
visual aid to the following explanation.</p><ul><li><p>When, e.g. an intermediate shard proposes a new block <code>blkA</code>, this block will have a reference to
a valid block from the history of the beacon chain.</p></li><li><p><code>blkA</code> will be submitted to the intermediate&rsquo;s shard parent, in this case the beacon chain, inside
an <code>IntermediateShardBlockInformation</code> data structure.</p></li><li><p>This process will be repeated for every new block in the shard: <code>blkB</code>, <code>blkC</code>, etc.</p></li><li><p>Verifying the validity of a shard block is done by making the regular block validity verification
and all the additional verifications imposed by the hierarchical consensus like checking that the
referenced beacon chain block is valid. You can already glimpse here how we are not only embedding
in the longest chain rule local consensus verifications, but also logic involving the overall
hierarchical consensus operation.</p></li><li><p>So far so good. However, all the shards in the system are running a probabilistic consensus. What
happens if there is a chain re-organisation and a heaviest chain surfaces replacing the current
longest-chain? Depending on the shard suffering the re-org, the impact is different. Fortunately,
all of them can be handled quite gracefully through the longest-chain rule.</p><ul><li>Upward reorgs, meaning leaf or intermediate shards that suffer a re-org, are easily detected. As
blocks are being submitted to the parent, the parent is able to identify that there is a
heaviest chain that needs to replace its current view of the child shard. This requires no
immediate action from the parent apart from this update of the parent&rsquo;s view of the heaviest
chain.</li><li>Reorgs from intermediate shards do not involve any immediate action from its child shards. The
newest heaviest chain may change the way (and specific blocks) where the information about the
child shard is being included into the parent chain and propagated to the parent chain, but this
shouldn&rsquo;t have any additional impact.</li><li>Finally, beacon chain re-orgs are the only onces that may trigger actions in the lower levels of
the hierarchy. When there is a heaviest chain in the beacon chain replacing the current longest
chain, this can trigger a re-org in some shards of the lower levels of the hierarchy that were
following the previous longest chain, as their beacon chain references for some of their blocks
may be deemed invalid. This event is also handled gracefully by the longest-chain rule. The
farmer entitled to create the next block in the child shard after the beacon re-org will build
the new block on top of the latest block in the child shard with a valid beacon chain block
reference after the re-org, continuing in this way constructing a valid chain in the shard.</li></ul></li></ul><p align=center><img alt="Sketch of core mechanics in block submission and re-org handling" src=reorg-sketch.png></p><h2 class="relative group">Shard segment commitment and block probability of reorganisation<div id=shard-segment-commitment-and-block-probability-of-reorganisation class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#shard-segment-commitment-and-block-probability-of-reorganisation aria-label=Anchor>#</a></span></h2><p>While handling re-organisations of shard block submissions is somewhat <em>&ldquo;cheap&rdquo;</em>, this is not the
case for shard segments. Segments committed to the beacon chain become part of the global history,
and will be conveniently archived in farmers plots. Reverting the archival of a segment is an
<em>&ldquo;expensive&rdquo;</em> operation that should be avoided at all costs. Consequently, segments should only be
propagated up and committed in the beacon chain when their probability of being reverted or
re-organised is negligible. This is the high-level proposal of how I am thinking about handling
this:</p><ul><li>Every parent chain (intermediate shard and the beacon chain) keeps a view of the current state of
their child shards through the shard blocks that they are periodically submitting. Through this
view, they can track of the segments that have been submitted by their children, and in what block
they were submitted.</li><li>Along with this view of blocks and segments, the parent chain will also keep track of the
probability of re-organisation for each recent block in the child shard to have a sense of when a
block can be considered final with high probability, and thus any segments submitted with it.</li><li>Segments are propagated to parents as soon as they are created, but they will only be confirmed
once the probability of re-org for the block where they were included is below certain threshold
(e.g 0.1%). Similarly, the beacon chain will only consider segments for inclusion in the global
history once the probability of re-org for the block where they were included is below 0.1%.</li><li>In parallel, as soon as a segment is created in a child shard, the data availability layer will be
checking that it is correctly encoded and can submit challenges that the segment is not valid.</li><li>If a block or a segment is challenged because is not available, it can&rsquo;t be verified, or it was
wrongly encoded, the beacon chain (or its corresponding parent for leaf shards) will pause the
commitment of new segments and blocks for the shard until a counter-challenge is sent reverting
the failure situation.</li><li>All of this is flow of information (i.e. block and segment challenges, re-org confirmations etc.)
is handled through the proposal of new valid blocks submitted from the lower to the upper layers
of the hierarchy.</li><li>With this, we add a dynamic waiting time for segments that depend on their probability of re-org
that gives enough time to consider the segments final and to challenge potential misbehaviors and
mistakes.</li></ul><p>To try and clarify the description above, let me share how this would work step-by-step for the
commitment of a segment <code>s1</code> for a leaf segment:</p><ol><li>A farmer in the leaf shard creates a segment <code>s1</code> that is included and submitted to the parent as
part of the <code>own_segments_root</code> field of the <code>LeafShardBlockInformation</code> data structure that is
included in <code>blkA</code> of its intermediate shard parent. <code>s1</code> was created in <code>blk1</code> of the leaf
shard.</li><li>As soon as the parent sees this new child segment, it includes it in its next
<code>IntermediateShardBlockInformation</code> inside <code>child_segment_root</code> included in <code>blkX</code> of the beacon
chain. This makes the leaf segment immediately available in the beacon chain, but it won&rsquo;t be
included into the global history, and be included in the corresponding super segment, until the
probability of re-org of all the blocks involved in the submission of the segment, mainly <code>blk1</code>,
<code>blkA</code> and <code>blkX</code> is over the finality threshold chosen.</li><li>The intermediate shard is periodically updating its perceived probability of reorg for the leaf&rsquo;s
shard <code>blk1</code> and it will notify the beacon chain in the following
<code>IntermediateShardBlockInformation</code> that the finality threshold has been achieved. Similarly, the
beacon chain keep track of this same threshold for <code>blkA</code>. When both are confirmed as final, the
leaf segment of that block is committed as part of the global history, assigned a global piece
index within that history, and made available for archiving.</li></ol><h2 class="relative group">Computing the block probability of reorganisation<div id=computing-the-block-probability-of-reorganisation class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#computing-the-block-probability-of-reorganisation aria-label=Anchor>#</a></span></h2><p>And many of you may be wondering at this point, but how can we compute the probability of
reorganisation for a block in the first place? Fortunately, there is a lot of literature around this
topic and attempts to objectively measure this metric or related ones for longest-chain protocols
(including the original Bitcoin white paper, with its analysis of its probability of attack):</p><ul><li><a href=https://bitcoin.org/bitcoin.pdf target=_blank>Satoshi Nakamoto&rsquo;s Bitcoin Whitepaper</a></li><li><a href=https://arxiv.org/abs/2012.10172 target=_blank>&ldquo;On Finality in Blockchains&rdquo; by Anceaume et al.</a></li><li>And quantitative approaches to blockchain finality for
<a href=https://link.springer.com/article/10.1007/s00145-016-0259-8 target=_blank>Markov Chain models</a>, and formal
analysis of Bitcoin&rsquo;s backbone and for
<a href=https://www.cs.cornell.edu/~ie53/publications/selfish-mining.pdf target=_blank>game theory and selfish mining</a>
(relevant to miner incentives and reorgs).</li></ul><p>From the analyses on these papers, I extracted the following high-level formula to compute the
probability of block reorganisation that we will be able to combine to our needs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=n>Prob</span><span class=w> </span><span class=p>(</span><span class=n>num_blocks_replaced</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=o>*</span><span class=n>time_to_first_block_propagation</span><span class=o>/</span><span class=n>avg_time_between_blocks</span><span class=p>)</span><span class=o>^</span><span class=p>(</span><span class=n>num_blocks_replaced</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h2 class="relative group">What&rsquo;s next?<div id=whats-next class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#whats-next aria-label=Anchor>#</a></span></h2><p>I shared here a pretty high-level overview of all of these new mechanics for block re-orgs and
segments commitments into the global history. This week I&rsquo;ll focus on having a spec-like low-level
step-by-step description of all of this mechanics so they can be reviewed by Nazar for them to
(hopefully) be in a good state to start being eventually prototyped.</p><p>In parallel, and as it&rsquo;s been the case for several weeks now, I want to find time to share how I am
imagining the data availability layer to work as part of the core protocol (not as an independent
layer as it is the case in other projects), and how I am planning to integrate its operation into
the longest-chain rule and the core protocol. As always, any feedback, ideas or suggestions? Hit me
up!</p></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_blog/2025/2025-05-26-longest-chain-rule-and-blocks-probability-of-reorganisation.md data-oid-likes=likes_blog/2025/2025-05-26-longest-chain-rule-and-blocks-probability-of-reorganisation.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/blog/2025-05-19-the-unblocker-blocks-as-a-forest-of-trees/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">The Unblocker - Blocks as a forest of trees</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-05-19T00:00:00+00:00>19 May 2025</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/blog/2025-06-02-path-to-block-production-and-procrastination/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Path to block production and procrastination</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-06-02T00:00:00+00:00>2 June 2025</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0 z-10"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400"><a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel="license noopener noreferrer">CC0 1.0 Universal</a></p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer></div></body></html>