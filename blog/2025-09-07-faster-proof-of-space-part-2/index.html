<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Faster Proof-of-Space (part 2) &#183; Project Abundance</title><meta name=title content="Faster Proof-of-Space (part 2) &#183; Project Abundance"><meta name=description content="Second part in a series of Proof-of-Space optimizations"><meta name=keywords content="status-update,"><link rel=canonical href=https://abundance.build/blog/2025-09-07-faster-proof-of-space-part-2/><link type=text/css rel=stylesheet href=/css/main.bundle.min.fd951ea54edeca1b6b08c8bbf3c93c284de4c78daf63a71d8016939775734cf68700f1662ed31d870100c676cbe1f65d150635cf368b874c49fc75147bcb04a9.css integrity="sha512-/ZUepU7eyhtrCMi788k8KE3kx42vY6cdgBaTl3VzTPaHAPFmLtMdhwEAxnbL4fZdFQY1zzaLh0xJ/HUUe8sEqQ=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.e4b2d9aece2aa7a740c3ee7a0efc5acf56b204868ab0fb5bba9be32aed1cd0c9262979d98050759068d58144297f74b12ed05b5173cf2df2e6c097a066b984a8.js integrity="sha512-5LLZrs4qp6dAw+56Dvxaz1ayBIaKsPtbupvjKu0c0MkmKXnZgFB1kGjVgUQpf3SxLtBbUXPPLfLmwJegZrmEqA==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://abundance.build/blog/2025-09-07-faster-proof-of-space-part-2/"><meta property="og:site_name" content="Project Abundance"><meta property="og:title" content="Faster Proof-of-Space (part 2)"><meta property="og:description" content="Second part in a series of Proof-of-Space optimizations"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-09-07T00:00:00+00:00"><meta property="article:modified_time" content="2025-09-07T00:00:00+00:00"><meta property="article:tag" content="status-update"><meta name=twitter:card content="summary"><meta name=twitter:title content="Faster Proof-of-Space (part 2)"><meta name=twitter:description content="Second part in a series of Proof-of-Space optimizations"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Blog","name":"Faster Proof-of-Space (part 2)","headline":"Faster Proof-of-Space (part 2)","description":"Second part in a series of Proof-of-Space optimizations","abstract":"\u003cp\u003eIn the \u003ca\n  href=\u0022..\/2025-08-26-faster-proof-of-space-part-1\u0022\u003epart 1\u003c\/a\u003e I shared some background information, performance improvements and future opportunities. Since then, I\nwas pursuing various approaches. Some worked out nicely, others were not so fruitful. Overall, I have achieved a\nsubstantial performance improvement on CPU with a few more options still remaining on the table, all while becoming\nsubstantially more GPU-friendly.\u003c\/p\u003e","inLanguage":"en","url":"https:\/\/abundance.build\/blog\/2025-09-07-faster-proof-of-space-part-2\/","author":{"@type":"Person","name":""},"copyrightYear":"2025","dateCreated":"2025-09-07T00:00:00\u002b00:00","datePublished":"2025-09-07T00:00:00\u002b00:00","dateModified":"2025-09-07T00:00:00\u002b00:00","keywords":["status-update"],"mainEntityOfPage":"true","wordCount":"1703"}]</script><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><link type=text/css rel=stylesheet href=/lib/katex/katex.min.7e7e35e3ef02b7b437449a44ca3fac62ec1ed39cb8312b680a00fe8ac60badc95b063b694636b8440856f7f5e8c2cc9e6b0efb581179b2656c7e1e97558c7096.css integrity="sha512-fn414+8Ct7Q3RJpEyj+sYuwe05y4MStoCgD+isYLrclbBjtpRja4RAhW9/Xowsyeaw77WBF5smVsfh6XVYxwlg=="><script defer type=text/javascript src=/js/katex.bundle.735b6f1542c0acf03d492dcdf14710c2e277474a64ae8ce49ef56563e17d142f9d3f4466e82cf12679968f50985628e08948ec341fba2df746545d0fd337d81d.js integrity="sha512-c1tvFULArPA9SS3N8UcQwuJ3R0pkrozknvVlY+F9FC+dP0Rm6CzxJnmWj1CYVijgiUjsNB+6LfdGVF0P0zfYHQ==" id=katex-render></script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">Project Abundance</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Faster Proof-of-Space (part 2)</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-09-07T00:00:00+00:00>7 September 2025</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">8 mins</span><span class="px-2 text-primary-500">&#183;</span>
<span class=mb-[2px]><a href=https://github.com/nazar-pc/abundance/tree/main/website/main/content/blog/2025/2025-09-07-faster-proof-of-space-part-2.md class="text-lg hover:text-primary-500" rel="noopener noreferrer" target=_blank title="Edit content"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg height="1em" viewBox="0 0 512 512"><path fill="currentColor" d="M441 58.9 453.1 71c9.4 9.4 9.4 24.6.0 33.9L424 134.1 377.9 88 407 58.9c9.4-9.4 24.6-9.4 33.9.0zM209.8 256.2 344 121.9 390.1 168 255.8 302.2c-2.9 2.9-6.5 5-10.4 6.1L186.9 325l16.7-58.5c1.1-3.9 3.2-7.5 6.1-10.4zM373.1 25 175.8 222.2c-8.7 8.7-15 19.4-18.3 31.1l-28.6 1e2c-2.4 8.4-.1 17.4 6.1 23.6s15.2 8.5 23.6 6.1l1e2-28.6c11.8-3.4 22.5-9.7 31.1-18.3L487 138.9c28.1-28.1 28.1-73.7.0-101.8L474.9 25C446.8-3.1 401.2-3.1 373.1 25zM88 64C39.4 64 0 103.4.0 152V424c0 48.6 39.4 88 88 88H360c48.6.0 88-39.4 88-88V312c0-13.3-10.7-24-24-24s-24 10.7-24 24V424c0 22.1-17.9 40-40 40H88c-22.1.0-40-17.9-40-40V152c0-22.1 17.9-40 40-40H2e2c13.3.0 24-10.7 24-24s-10.7-24-24-24H88z"/></svg></span></span></a></span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] mr-2" href=/tags/status-update/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">status-update</span></span></a></div></div><div class="flex author"><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class="flex author author-extra mt-4"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 src=/3d67cc976284fd62356e2edd8a8dfc49_2651210052118205119_hu_2fd6f6eca7f7083d.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><a href=https://abundance.build/authors/nazar-pc/ class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Nazar Mokrynskyi</a><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://linkedin.com/in/nazarpc target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://x.com/nazarpc target=_blank aria-label=X-Twitter rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span></span></a>
<a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/nazar-pc target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:nazar@mokrynskyi.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>In the <a href=../2025-08-26-faster-proof-of-space-part-1>part 1</a> I shared some background information, performance improvements and future opportunities. Since then, I
was pursuing various approaches. Some worked out nicely, others were not so fruitful. Overall, I have achieved a
substantial performance improvement on CPU with a few more options still remaining on the table, all while becoming
substantially more GPU-friendly.</p><h2 class="relative group">Specification<div id=specification class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#specification aria-label=Anchor>#</a></span></h2><p>Reading upstream Chia documentation to understand how things should be implemented is challenging, so there is a
<a href=https://subspace.github.io/protocol-specs/docs/consensus/proof_of_space target=_blank>Subspace specification</a> that describes things in a much clearer and more approachable way. Well, at least in theory it
does that. In practice, though, it confuses the specification of what needs to be done with an efficient implementation
strategy. And at least for our use cases, it just happened to be the case that the implementation strategy assumed there
wasn&rsquo;t the best one.</p><p>What we&rsquo;re essentially doing is creating a bunch of tables and searching for matches between them. Yes, we can sort the
tables, but that is, strictly speaking, not necessary. The only thing we actually need is buckets that represent ranges
of <code>y</code> values, but the order inside doesn&rsquo;t really matter and never surfaces in the proof structure. The only thing
affected is proof order, which has already been a bit of an annoyance before.</p><p>It is easier to create a sequential implementation that is deterministic, it is a bit harder to make one that is fast.
And it is even more difficult to create a fast parallel one that behaves the same way on both CPU and GPU.</p><h2 class="relative group">New high-level strategy<div id=new-high-level-strategy class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#new-high-level-strategy aria-label=Anchor>#</a></span></h2><p>I started with the observation that only buckets are really necessary. I already did some statistical analysis mentioned
in the previous post to discover that for any K that is relevant, the upper bound for the size of the bucket is 512.
Coincidentally, the number of matches for a pair of buckets also has the same upper bound.</p><p>With this knowledge we can do two major implementation changes:</p><ul><li>instead of sorting tables by <code>y</code> value, only assign <code>y</code> values to buckets (by dividing them by <code>PARAM_BC = 15113</code>)</li><li>when searching for matches in pairs of buckets, store the results in the pre-allocated bucket-sized allocation</li></ul><p>This results in a few things that are good for performance:</p><ul><li>results of matches no longer need to be concatenated and sorted, they can stay where they were written originally when
the match was found and parallel version can easily achieve the same deterministic order as sequential one</li><li>instead of doing a bunch of memory copies and potential allocations (depending on the sorting algorithm), we do a
single scan to assign buckets to <code>y</code> values</li></ul><p>While bucketing requires a lot of random writes, the small total size of the data appears to be quite friendly for CPU
caches and performs reasonably well.</p><p>I even tried to use SIMD for bucketing, but faced a problem, which was one of the promising potential optimizations I
mentioned last time.</p><h2 class="relative group">Handling of <code>y</code> duplicates and size bounds<div id=handling-of-y-duplicates-and-size-bounds class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#handling-of-y-duplicates-and-size-bounds aria-label=Anchor>#</a></span></h2><p>One of the challenges with SIMD bucketing is the fact that <code>y</code> values can be duplicated. The behavior of the scatter
operation is that only the last write will be observed. On the surface this is not a problem, but it does impact the
number of matches found down the line and the number of proofs that can be found as the result. After doing experiments,
it turned out that this decreases the number of proofs found too much. By too much I mean that it would not be possible
to make plotted sector contain only the chunks which can be farmed, which is undesirable.</p><p>If duplicates are no-go, how many matches do we actually need and how small can we make the buckets? I did many more
experiments and came up with numbers 288 (a multiple of 32) and 272 (a multiple of 8) for both. These appear to be large
enough for plenty of proofs to be available, while also being substantially smaller than 512, which reduces memory usage
and significantly increases performance. These smaller sizes should also make it more likely that the data will fit in
shared memory on more (all?) GPUs.</p><p>It is really important to know what you&rsquo;re doing and why to be able to make such decisions.</p><p>While getting rid of duplicates results in not enough proofs, it doesn&rsquo;t mean any number of duplicates needs to be
supported. This is especially important for GPU implementation, where diverging control flow kills the performance.
After extensive testing I concluded that supporting just a single duplicate is sufficient. This is also fast on CPU
since handling of the second duplicate is only needed when the first duplicate exists. And most of the time there are no
matches at all, so the CPU can have a decent chance at successfully predicting branches, and GPU threads will mostly
progress without divergence.</p><h2 class="relative group">Finding proofs<div id=finding-proofs class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#finding-proofs aria-label=Anchor>#</a></span></h2><p>One place where sorted <code>y</code> values are really beneficial is finding proofs. This process involves finding <code>y</code> matching
the challenge and propagating back through the tables to generate a proof. But if there are only buckets, this doesn&rsquo;t
work. Another option is to do full scan and since there are buckets, only buckets that overlap with matching range need
to be scanned.</p><p>This is substantially slower than binary search, especially when proof doesn&rsquo;t exist. But on the flip side the number of
proofs that need to be checked is upper bound by \(2^{16}\), significantly smaller in practice, and the case where
proof isn&rsquo;t found is the minority. So in the end for this number of searches, the increase in proof search time is
overwhelmed with decrease in table construction time, and is a net positive change overall.</p><p>Scan is also very CPU-friendly due to predictable behavior (in terms of memory access pattern and branching), so the
performance for when proof is found is actually not far off from the binary search in practice. One of many initially
counter-intuitive cases where doing strictly more work might end up being faster due to how real-world hardware is
designed.</p><h2 class="relative group">Memory optimizations<div id=memory-optimizations class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#memory-optimizations aria-label=Anchor>#</a></span></h2><p>Something I carried in local branches, but didn&rsquo;t really see a massive difference from was pruning the data from parent
tables after they are used. More specifically, both metadata and <code>y</code> values are not needed after the next table is
constructed since proof generation is only concerned with <code>x</code> values the final <code>y</code> was derived from.</p><p>Now that there are fewer allocations and things fit better and better into CPU cache, pruning metadata and intermediate
<code>y</code> values resulted in performance improvements. Moreover, since tables are no longer sorted by <code>y</code>, the position into
the first table is the same as <code>x</code> value, so <code>x</code> values are not stored anymore and the whole first table is dropped as
soon as the second table is constructed.</p><p>All these tricks shaved off about 40% of the memory usage!</p><p>I&rsquo;m very curious to see how this impacts the performance on CPUs with 3D V-cache, where the absolute majority if not all
the data will stay in cache at all times ðŸ”¥</p><h2 class="relative group">Results<div id=results class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#results aria-label=Anchor>#</a></span></h2><p>Not every hypothetical improvement results in actual performance improvement. Sometimes it really depends on what fits
into the cache and what doesn&rsquo;t, so it is not obvious when performance will improve and when it will decrease. So all
this took quite a long time with countless benchmark runs and failed experiments.</p><p>The changes described above and then some were implemented in <a href=https://github.com/nazar-pc/abundance/pull/380 target=_blank>PR 380</a> and <a href=https://github.com/nazar-pc/abundance/pull/381 target=_blank>PR 381</a>.</p><p>The results are still a bit variable due to my machine not staying idle, but when limited to a single CXX on AMD
Threadripper 7970X CPU (roughly equivalent to 8C16T AMD Ryzen 7700X CPU), the results are as follows:</p><pre tabindex=0><code>Before:
chia/table/single/1x    time:   [920.37 ms 924.24 ms 929.24 ms]
                        thrpt:  [1.0762  elem/s 1.0820  elem/s 1.0865  elem/s]
chia/table/parallel/8x  time:   [677.60 ms 684.25 ms 692.06 ms]
                        thrpt:  [11.560  elem/s 11.692  elem/s 11.806  elem/s]
chia/proof/missing      time:   [20.764 ns 21.179 ns 21.459 ns]
                        thrpt:  [46.600 Melem/s 47.217 Melem/s 48.160 Melem/s]
chia/proof/present      time:   [360.24 ns 360.65 ns 361.08 ns]
                        thrpt:  [2.7695 Melem/s 2.7727 Melem/s 2.7760 Melem/s]
After:
chia/table/single/1x    time:   [747.82 ms 756.94 ms 768.09 ms]
                        thrpt:  [1.3019  elem/s 1.3211  elem/s 1.3372  elem/s]
chia/table/parallel/8x  time:   [529.15 ms 534.42 ms 540.15 ms]
                        thrpt:  [14.811  elem/s 14.969  elem/s 15.119  elem/s]
chia/proof/missing      time:   [101.94 ns 102.22 ns 102.58 ns]
                        thrpt:  [9.7486 Melem/s 9.7824 Melem/s 9.8099 Melem/s]
chia/proof/present      time:   [376.64 ns 377.52 ns 379.55 ns]
                        thrpt:  [2.6347 Melem/s 2.6489 Melem/s 2.6551 Melem/s]
</code></pre><p>As mentioned before, proof searching performance decreased, especially for misses, but it is on average ~4 ms per table,
which is more than compensated by the table construction time improvement.</p><p>I still remember the time when we were struggling with table construction for proving. It was taking so long using
reference Chia implementation that we had to introduce the delay into the protocol design to make sure farmers have a
few seconds to generate a proof in time ðŸ¥¹. Now we casually create tables in 750 ms on a single CPU core and A LOT less
than that when multithreaded (which is the default for proving BTW).</p><h2 class="relative group">Optimizations that didn&rsquo;t work out<div id=optimizations-that-didnt-work-out class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#optimizations-that-didnt-work-out aria-label=Anchor>#</a></span></h2><p>There were many things that didn&rsquo;t work out, but most notably a version with binary search over sorted <code>y</code>s I mentioned
last time. Not needing to sort at all was such a massive win and simplification for both CPU and GPU that I don&rsquo;t think
I will go back to it, but it took a few days to get working reasonably well. Still, it was an interesting experience I&rsquo;m
sure I&rsquo;ll find applications for in the future.</p><h2 class="relative group">Upcoming plans<div id=upcoming-plans class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#upcoming-plans aria-label=Anchor>#</a></span></h2><p>After implementation was pretty well tuned in Subspace I&rsquo;m still finding ways to do major performance improvements, even
if it means backwards incompatible changes for farmers. For now, though, I think this is mostly it for the CPU side, and
I&rsquo;ll be switching back to GPU where I&rsquo;ll no longer need to implement custom sorting and other complicated things.</p><p>Fingers crossed for the next update in this series to talk about how this all works nicely on GPU with <a href=https://github.com/Rust-GPU/rust-gpu target=_blank>rust-gpu</a>.</p><p>If you have any feedback about this or anything else related to the project, I&rsquo;m not difficult to find on <a href=https://abundance.zulipchat.com/ target=_blank>Zulip</a>.</p></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_blog/2025/2025-09-07-faster-proof-of-space-part-2.md data-oid-likes=likes_blog/2025/2025-09-07-faster-proof-of-space-part-2.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/blog/2025-08-26-faster-proof-of-space-part-1/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Faster Proof-of-Space (part 1)</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-08-26T00:00:00+00:00>26 August 2025</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/blog/2025-09-18-faster-proof-of-space-part-3/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Faster Proof-of-Space (part 3)</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-09-18T00:00:00+00:00>18 September 2025</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0 z-10"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400"><a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel="license noopener noreferrer">CC0 1.0 Universal</a></p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer></div></body></html>