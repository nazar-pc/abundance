<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Contracts CLI and RISC-V interpreter &#183; Project Abundance</title><meta name=title content="Contracts CLI and RISC-V interpreter &#183; Project Abundance"><meta name=description content="Exploring ELF and RISC-V with prototypes of key components"><meta name=keywords content="status-update,"><link rel=canonical href=https://abundance.build/blog/2025-12-29-contracts-cli-and-risc-v-interpreter/><link type=text/css rel=stylesheet href=/css/main.bundle.min.fd951ea54edeca1b6b08c8bbf3c93c284de4c78daf63a71d8016939775734cf68700f1662ed31d870100c676cbe1f65d150635cf368b874c49fc75147bcb04a9.css integrity="sha512-/ZUepU7eyhtrCMi788k8KE3kx42vY6cdgBaTl3VzTPaHAPFmLtMdhwEAxnbL4fZdFQY1zzaLh0xJ/HUUe8sEqQ=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.e4b2d9aece2aa7a740c3ee7a0efc5acf56b204868ab0fb5bba9be32aed1cd0c9262979d98050759068d58144297f74b12ed05b5173cf2df2e6c097a066b984a8.js integrity="sha512-5LLZrs4qp6dAw+56Dvxaz1ayBIaKsPtbupvjKu0c0MkmKXnZgFB1kGjVgUQpf3SxLtBbUXPPLfLmwJegZrmEqA==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://abundance.build/blog/2025-12-29-contracts-cli-and-risc-v-interpreter/"><meta property="og:site_name" content="Project Abundance"><meta property="og:title" content="Contracts CLI and RISC-V interpreter"><meta property="og:description" content="Exploring ELF and RISC-V with prototypes of key components"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-12-29T00:00:00+00:00"><meta property="article:modified_time" content="2025-12-29T00:00:00+00:00"><meta property="article:tag" content="status-update"><meta name=twitter:card content="summary"><meta name=twitter:title content="Contracts CLI and RISC-V interpreter"><meta name=twitter:description content="Exploring ELF and RISC-V with prototypes of key components"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Blog","name":"Contracts CLI and RISC-V interpreter","headline":"Contracts CLI and RISC-V interpreter","description":"Exploring ELF and RISC-V with prototypes of key components","abstract":"\u003cp\u003eSwitching to something that I thought would be more fun, I decided to look into ELF and RISC-V last week or so. I\nlearned more than I wanted and managed to achieve a few key deliverables:\u003c\/p\u003e\n\u003cul\u003e\n\u003cli\u003edesign initial CLI for building\/converting\/verifying contract files\u003c\/li\u003e\n\u003cli\u003edefine and implement a contract file format\u003c\/li\u003e\n\u003cli\u003eimplement a simple RISC-V interpreter\u003c\/li\u003e\n\u003c\/ul\u003e\n\u003cp\u003eLet\u0026rsquo;s look into each of those in more detail.\u003c\/p\u003e","inLanguage":"en","url":"https:\/\/abundance.build\/blog\/2025-12-29-contracts-cli-and-risc-v-interpreter\/","author":{"@type":"Person","name":""},"copyrightYear":"2025","dateCreated":"2025-12-29T00:00:00\u002b00:00","datePublished":"2025-12-29T00:00:00\u002b00:00","dateModified":"2025-12-29T00:00:00\u002b00:00","keywords":["status-update"],"mainEntityOfPage":"true","wordCount":"2128"}]</script><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">Project Abundance</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Contracts CLI and RISC-V interpreter</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-12-29T00:00:00+00:00>29 December 2025</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">10 mins</span><span class="px-2 text-primary-500">&#183;</span>
<span class=mb-[2px]><a href=https://github.com/nazar-pc/abundance/tree/main/website/main/content/blog/2025/2025-12-29-contracts-cli-and-risc-v-interpreter.md class="text-lg hover:text-primary-500" rel="noopener noreferrer" target=_blank title="Edit content"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg height="1em" viewBox="0 0 512 512"><path fill="currentColor" d="M441 58.9 453.1 71c9.4 9.4 9.4 24.6.0 33.9L424 134.1 377.9 88 407 58.9c9.4-9.4 24.6-9.4 33.9.0zM209.8 256.2 344 121.9 390.1 168 255.8 302.2c-2.9 2.9-6.5 5-10.4 6.1L186.9 325l16.7-58.5c1.1-3.9 3.2-7.5 6.1-10.4zM373.1 25 175.8 222.2c-8.7 8.7-15 19.4-18.3 31.1l-28.6 1e2c-2.4 8.4-.1 17.4 6.1 23.6s15.2 8.5 23.6 6.1l1e2-28.6c11.8-3.4 22.5-9.7 31.1-18.3L487 138.9c28.1-28.1 28.1-73.7.0-101.8L474.9 25C446.8-3.1 401.2-3.1 373.1 25zM88 64C39.4 64 0 103.4.0 152V424c0 48.6 39.4 88 88 88H360c48.6.0 88-39.4 88-88V312c0-13.3-10.7-24-24-24s-24 10.7-24 24V424c0 22.1-17.9 40-40 40H88c-22.1.0-40-17.9-40-40V152c0-22.1 17.9-40 40-40H2e2c13.3.0 24-10.7 24-24s-10.7-24-24-24H88z"/></svg></span></span></a></span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] mr-2" href=/tags/status-update/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">status-update</span></span></a></div></div><div class="flex author"><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class="flex author author-extra mt-4"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 src=/3d67cc976284fd62356e2edd8a8dfc49_2651210052118205119_hu_2fd6f6eca7f7083d.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><a href=https://abundance.build/authors/nazar-pc/ class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Nazar Mokrynskyi</a><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://linkedin.com/in/nazarpc target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://x.com/nazarpc target=_blank aria-label=X-Twitter rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span></span></a>
<a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/nazar-pc target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:nazar@mokrynskyi.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>Switching to something that I thought would be more fun, I decided to look into ELF and RISC-V last week or so. I
learned more than I wanted and managed to achieve a few key deliverables:</p><ul><li>design initial CLI for building/converting/verifying contract files</li><li>define and implement a contract file format</li><li>implement a simple RISC-V interpreter</li></ul><p>Let&rsquo;s look into each of those in more detail.</p><h2 class="relative group">Initial CLI for building/converting/verifying contract files<div id=initial-cli-for-buildingconvertingverifying-contract-files class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#initial-cli-for-buildingconvertingverifying-contract-files aria-label=Anchor>#</a></span></h2><p>I spent quite some time in the past thinking about how the contracts should be built and what the developer experience
about that would look like. Ideally, the developer would just call <code>cargo build</code> and get a file they can upload to the
blockchain. Unfortunately, things are not quite that simple, at least for now, and there are multiple reasons for that.</p><p>The first reason is that there isn&rsquo;t an official target that would fit the use case for contracts perfectly, which means
a custom target specification is needed, which involves custom CLI options and requirement of a nightly Rust toolchain.
Not only that, the standard library is not available for custom targets, and there is no way to specify that it needs to
be built on demand, which requires more CLI options. And on top of everything I really wanted the developer experience
writing and interacting with contracts look as &ldquo;normal&rdquo; as possible, meaning not requiring special crate type
definitions in the <code>Cargo.toml</code> and having extra build artifacts when a contract is used as a dependency, which leads to
even more CLI options and the need to build with <code>cargo rustc</code> instead of <code>cargo build</code>.</p><p>For my experiments I used a command that looked something like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cargo rustc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --crate-type cdylib <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -Z build-std<span class=o>=</span>core <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --package ab-example-contract-flipper <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --features ab-example-contract-flipper/guest <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --profile production <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --target crates/contracts/riscv64em-unknown-none-abundance.json
</span></span></code></pre></div><p>I&rsquo;m sure it is easy to see that it is not fun to deal with all the time. Not to mention that anyone using it would have
to have an up-to-date version if the target specification file somewhere nearby at all times.</p><p>I decided to implement a cargo extension CLI <code>cargo ab-contract</code> that would simplify the process of building contracts
and provide a more convenient experience for developers. The first step taken in <a href=https://github.com/nazar-pc/abundance/pull/483 target=_blank>PR 483</a> was to implement <code>convert</code>
command that takes ELF <code>cdylib</code> as an input and produces a contract file as an output, which was extended with <code>verify</code>
command in <a href=https://github.com/nazar-pc/abundance/pull/493 target=_blank>PR 493</a> and <code>build</code> command that replaces that messy <code>cargo rustc</code> command followed by
<code>cargo ab-contract convert</code> with a simple <code>cargo ab-contract build</code> in <a href=https://github.com/nazar-pc/abundance/pull/494 target=_blank>PR 494</a>.</p><p>Eventually I plan to implement <code>recover</code> command that would take a contract file as an input and produce an ELF
<code>cdylib</code> that would behave similarly to the original one, which may be useful for debugging purposes with traditional
tooling, but it is not 100% clear if that would ever be actually necessary. We&rsquo;ll see.</p><h2 class="relative group">Contract file format<div id=contract-file-format class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#contract-file-format aria-label=Anchor>#</a></span></h2><p>Since I mentioned multiple times in the past that the plan was to use ELF files, you might be wondering why the
conversion step is necessary? Well, I spent a lot of time researching and experimenting with ELF RISC-V <code>cdylib</code> files
and what they look like. Turns out there is A LOT to it, and it is quite non-trivial to process them correctly, not to
mention that they support so many potential things that will never be needed. On top of that, there is a size concern.
For simple contracts various sections and headers ELF files typically contain are just dead weight, and with contract
metadata included in statics, some of it ends up being duplicated in the output file.</p><p>I also spent some time looking into what PolkaVM does and some other projects and concluded that it would be beneficial
to have something way simpler that would be trivial to parse and would only contain the bare minimum necessary.</p><p>While looking at the file format, I was also thinking about interpreter/static binary recompiler implementation and the
way memory is supposed to be organized during execution. PolkaVM has an interesting WASM-like design where address space
for code and data are separate and code can&rsquo;t be read, only executed. I decided to not go that way to make the contract
file as close to the original ELF <code>cdylib</code> as possible and to make the conversion process dead simple.</p><p>This also raises the question about what features should even be supported from the developer perspective. For example,
thread-local storage (TLS) is not useful in a single-threaded environment, I decided early on to not have syscalls and
dynamic memory allocation, but should global mutable statics be available? I ultimately decided that no global mutable
statics should be supported. Rather, a generous amount of stack space (by blockchain standards) will be given during
contract execution, and that is all code will have to work with (in addition to input/output arguments of the contract
call). I learned to dislike global mutable state of all kinds over the years, so this is in-line with my evolved
personal preferences.</p><p>So what we&rsquo;re left with in terms of what the file should contain is read-only data (constants, read-only statics,
contract metadata) and code. Code can remain mutable, but nothing outside the code section will be executable.</p><p>The conversion process then consists of a bunch of checks to ensure the ELF file doesn&rsquo;t contain what can&rsquo;t be supported
by the contract, then a small header is written first followed by a read-only section and code section from the ELF
file. I made sure to preserve relative offsets between read-only data and code sections such that no fixups are needed
for execution and reversing is still possible.</p><p>The header right now looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=sd>/// Header of the contract file
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=cp>#[derive(Debug, Clone, Copy, PartialEq, Eq, TrivialType)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[repr(C)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>ContractFileHeader</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Always [`CONTRACT_FILE_MAGIC`]
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>magic</span>: <span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>4</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Size of the read-only section in bytes as stored in the file
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>read_only_section_file_size</span>: <span class=kt>u32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Size of the read-only section in bytes as will be written to memory during execution.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>///
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// If larger than `read_only_section_file_size`, then zeroed padding needs to be added.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>read_only_section_memory_size</span>: <span class=kt>u32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Offset of the metadata section in bytes relative to the start of the file
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>metadata_offset</span>: <span class=kt>u32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Size of the metadata section in bytes
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>metadata_size</span>: <span class=kt>u16</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Number of methods in the contract
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>num_methods</span>: <span class=kt>u16</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Host call function offset in bytes relative to the start of the file.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>///
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// `0` means no host call.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>host_call_fn_offset</span>: <span class=kt>u32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>It is then followed by a bunch of pointers to exported contract methods:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=sd>/// Metadata about each method of the contract that can be called from the outside
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=cp>#[derive(Debug, Clone, Copy, PartialEq, Eq, TrivialType)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[repr(C)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>ContractFileMethodMetadata</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Offset of the method code in bytes relative to the start of the file
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>offset</span>: <span class=kt>u32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Size of the method code in bytes
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>size</span>: <span class=kt>u32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>This is all that is needed to load read-only data and code into memory, find/decode contract metadata (which tells us
about all available methods) and where to find them in memory for execution. I even wrote a simple CLI to call such
contracts.</p><p><code>host_call_fn_offset</code> is a special case, it tells us where the host call function is located in memory. Since I didn&rsquo;t
want to use syscalls, the host call is simply an external import in the ELF file, which is proxied through the exported
function. The exported function has a distinct assembly that can be rewritten during execution into something that acts
as a host call, while loading ELF <code>cdylib</code> in a regular RISC-V process allows making host calls through a regular
mechanism shared libraries normally use. Feels a bit hacky, so let me know if you know something better.</p><p>The code section is parsed as a series of RISC-V instructions and if unexpected instructions are encountered, like
<code>ecall</code> used for making syscalls, the whole contract is rejected as invalid.</p><p>I&rsquo;m still thinking whether I should make it a requirement for contracts to be compressed with Zstandard. If so, it would
be possible to include the padding that sometimes appears between read-only data and code sections in the file size,
such that when the contract is decompressed, it doesn&rsquo;t need any post-processing to be loaded into memory, and the
decompressed data would already have the correct memory layout. From what I found, it should be fine security-wise, but
I am still hesitant for some reason. Thankfully, there is a <a href=https://github.com/KillingSpark/zstd-rs target=_blank>rust decompression crate</a>, so I wouldn&rsquo;t have to mess with
bindings if I go that route.</p><p>Initial file format definition landed together with <code>cargo ab-contract</code> in <a href=https://github.com/nazar-pc/abundance/pull/483 target=_blank>PR 483</a> with some fixes in <a href=https://github.com/nazar-pc/abundance/pull/485 target=_blank>PR 485</a>, parsing
of the new file was implemented in <a href=https://github.com/nazar-pc/abundance/pull/487 target=_blank>PR 487</a> and that was used for verification post-conversion from ELF <code>cdylib</code>
in <a href=https://github.com/nazar-pc/abundance/pull/493 target=_blank>PR 493</a> along with instruction parsing and verification.</p><h2 class="relative group">RISC-V interpreter<div id=risc-v-interpreter class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#risc-v-interpreter aria-label=Anchor>#</a></span></h2><p>To test all of the above, I needed a way to run RISC-V code. An interpreter is a great way to start, and I was
pleasantly surprised by both how simple RISC-V really is compared to something like x86-64 and how capable LLMs are
generating initial mostly working prototype and lengthy tests for it.</p><p>I started with a new target specification in <a href=https://github.com/nazar-pc/abundance/pull/481 target=_blank>PR 481</a> since I needed to be able to produce the files first. I was
actually running ELF files directly at first, which helped me to explore and design my own file format. Initial
definition of registers and instructions landed in <a href=https://github.com/nazar-pc/abundance/pull/483 target=_blank>PR 483</a> with the file format introduction. To make it potentially
more usable outside the project, I refactored registers in <a href=https://github.com/nazar-pc/abundance/pull/486 target=_blank>PR 486</a> so not just RV64E, but also RV64I base ISA is
supported. After all, the only difference between the two is the number of general purpose registers and literally
nothing else.</p><p>Calling some methods incorrectly, I quickly discovered magic instruction <code>0xc0001073</code> that <code>objdump</code> read as <code>unimp</code>,
which various compilers canonically use as invalid instruction for panics, so I added support for that in <a href=https://github.com/nazar-pc/abundance/pull/488 target=_blank>PR 488</a> too.
Encouraged by how helpful LLMs were in generating instruction parser, I used them to generate almost two thousand lines
of tests in <a href=https://github.com/nazar-pc/abundance/pull/489 target=_blank>PR 489</a>. While I didn&rsquo;t audit the 100% of tests, they look good enough for now.</p><p>With all those preparations I was finally able to land an interpreter I was toying with for a few days in a local branch
in <a href=https://github.com/nazar-pc/abundance/pull/490 target=_blank>PR 490</a>. It is a very basic textbook interpreter that decodes and executes one instruction at a time. Low
performance, no gas metering, etc., but it works and can be built upon or used as a reference.</p><h2 class="relative group">Shard allocation follow-up<div id=shard-allocation-follow-up class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#shard-allocation-follow-up aria-label=Anchor>#</a></span></h2><p><a href=../2025-12-19-permissionless-assignments-of-farmers-to-shards>The previous update</a> was about the initial shard allocation implementation, which I briefly continued before switching
to RISC-V-related business.</p><p>As mentioned there, I wasn&rsquo;t quite happy with a shard rotation interval measured in slots, so I switched it to beacon
chain blocks in <a href=https://github.com/nazar-pc/abundance/pull/480 target=_blank>PR 480</a>, which was a big simplification, especially to intermediate and leaf shards implementation when
time comes. I missed tying allocation to the public key hash initially and fixed it in <a href=https://github.com/nazar-pc/abundance/pull/482 target=_blank>PR 482</a>.</p><p>The last improvement is a very basic algorithm for reducing the total set of unique history sizes used per plot
in <a href=https://github.com/nazar-pc/abundance/pull/479 target=_blank>PR 479</a>. It is functional but has a high chance of resulting in too much replotting and also might cause recent
history being significantly underrepresented compared to Subspace. I decided to not overengineer it for now, but it&rsquo;d
be nice to calculate the probabilities and decide what the algorithm should look like long-term and how the reference
implementation should behave when it comes to replotting.</p><h2 class="relative group">Upcoming plans<div id=upcoming-plans class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#upcoming-plans aria-label=Anchor>#</a></span></h2><p>With a basic interpreter in place, it is still not enough to run contracts. An execution environment needs to be
implemented around it similarly to the already existing native execution environment. It&rsquo;ll probably take a couple of
weeks before I have that, but there are zero unknowns about its feasibility at this point.</p><p>I&rsquo;d like to write some benchmarks and see what kind of performance I get and how difficult it would be to make it
half-decent with minimal effort.</p><p>This will keep me occupied for a while, I&rsquo;ll decide when to tackle gas metering and other things later, though I have
been doing some research on that already.</p><p>This week felt more lively than usual, which I&rsquo;m quite happy about. We&rsquo;ll see how the next one goes.</p><p>It has actually been almost exactly one year since the project formally started. I&rsquo;ll be writing a post summarizing
the progress so far and the road ahead, which with some luck will become a yearly occurrence for many years to come.</p><p><a href=https://abundance.zulipchat.com/ target=_blank>Zulip</a> is where you can find me to chat about anything related to this update or the project in general.</p></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_blog/2025/2025-12-29-contracts-cli-and-risc-v-interpreter.md data-oid-likes=likes_blog/2025/2025-12-29-contracts-cli-and-risc-v-interpreter.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/blog/2025-12-19-permissionless-assignments-of-farmers-to-shards/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Permissionless assignments of farmers to shards</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-12-19T00:00:00+00:00>19 December 2025</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/blog/2026-01-01-a-year-of-abundance/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">A year of Abundance</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2026-01-01T00:00:00+00:00>1 January 2026</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0 z-10"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400"><a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel="license noopener noreferrer">CC0 1.0 Universal</a></p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer></div></body></html>