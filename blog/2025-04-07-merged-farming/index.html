<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Merged Farming &#183; Project Abundance</title><meta name=title content="Merged Farming &#183; Project Abundance"><meta name=description content="Distilling the core mechanisms for a multi-shard Subspace protocol."><meta name=keywords content="status-update,consensus,"><link rel=canonical href=https://abundance.build/blog/2025-04-07-merged-farming/><link type=text/css rel=stylesheet href=/css/main.bundle.min.fd951ea54edeca1b6b08c8bbf3c93c284de4c78daf63a71d8016939775734cf68700f1662ed31d870100c676cbe1f65d150635cf368b874c49fc75147bcb04a9.css integrity="sha512-/ZUepU7eyhtrCMi788k8KE3kx42vY6cdgBaTl3VzTPaHAPFmLtMdhwEAxnbL4fZdFQY1zzaLh0xJ/HUUe8sEqQ=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.e4b2d9aece2aa7a740c3ee7a0efc5acf56b204868ab0fb5bba9be32aed1cd0c9262979d98050759068d58144297f74b12ed05b5173cf2df2e6c097a066b984a8.js integrity="sha512-5LLZrs4qp6dAw+56Dvxaz1ayBIaKsPtbupvjKu0c0MkmKXnZgFB1kGjVgUQpf3SxLtBbUXPPLfLmwJegZrmEqA==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://abundance.build/blog/2025-04-07-merged-farming/"><meta property="og:site_name" content="Project Abundance"><meta property="og:title" content="Merged Farming"><meta property="og:description" content="Distilling the core mechanisms for a multi-shard Subspace protocol."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-04-07T00:00:00+00:00"><meta property="article:modified_time" content="2025-04-07T00:00:00+00:00"><meta property="article:tag" content="status-update"><meta property="article:tag" content="consensus"><meta name=twitter:card content="summary"><meta name=twitter:title content="Merged Farming"><meta name=twitter:description content="Distilling the core mechanisms for a multi-shard Subspace protocol."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Blog","name":"Merged Farming","headline":"Merged Farming","description":"Distilling the core mechanisms for a multi-shard Subspace protocol.","abstract":"\u003cp\u003eThis week I\u0026rsquo;ve gone a bit deeper into the design of the multi-shard Subspace protocol idea which I briefly introduced in\nmy last update. The protocol is conformed by the following parts:\u003c\/p\u003e\n\u003cul\u003e\n\u003cli\u003eSharded archiving, responsible for creating a global canonical history of the whole system, and of creating the\nhistory records that will eventually become part of farmers\u0026rsquo; plots.\u003c\/li\u003e\n\u003cli\u003eSharded plotting, which takes records from the global history and seals them in plots that include segments of the\nhistory of every shard of the system, and that will be used for the farming process.\u003c\/li\u003e\n\u003cli\u003eAnd finally, merged farming, which is the protocol responsible for challenging farmer plots, and deriving the\ncorresponding winning tickets that elect block proposers in specific shards.\u003c\/li\u003e\n\u003c\/ul\u003e\n\u003cp\u003eLet me introduce the high-level operation behind each of these sub-protocols, while digging deep in the one that I\u0026rsquo;ve\nfocused the most on this week: sharded archiving.\u003c\/p\u003e","inLanguage":"en","url":"https:\/\/abundance.build\/blog\/2025-04-07-merged-farming\/","author":{"@type":"Person","name":""},"copyrightYear":"2025","dateCreated":"2025-04-07T00:00:00\u002b00:00","datePublished":"2025-04-07T00:00:00\u002b00:00","dateModified":"2025-04-07T00:00:00\u002b00:00","keywords":["status-update","consensus"],"mainEntityOfPage":"true","wordCount":"1872"}]</script><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">Project Abundance</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Merged Farming</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-04-07T00:00:00+00:00>7 April 2025</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">9 mins</span><span class="px-2 text-primary-500">&#183;</span>
<span class=mb-[2px]><a href=https://github.com/nazar-pc/abundance/tree/main/website/main/content/blog/2025/2025-04-07-merged-farming.md class="text-lg hover:text-primary-500" rel="noopener noreferrer" target=_blank title="Edit content"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg height="1em" viewBox="0 0 512 512"><path fill="currentColor" d="M441 58.9 453.1 71c9.4 9.4 9.4 24.6.0 33.9L424 134.1 377.9 88 407 58.9c9.4-9.4 24.6-9.4 33.9.0zM209.8 256.2 344 121.9 390.1 168 255.8 302.2c-2.9 2.9-6.5 5-10.4 6.1L186.9 325l16.7-58.5c1.1-3.9 3.2-7.5 6.1-10.4zM373.1 25 175.8 222.2c-8.7 8.7-15 19.4-18.3 31.1l-28.6 1e2c-2.4 8.4-.1 17.4 6.1 23.6s15.2 8.5 23.6 6.1l1e2-28.6c11.8-3.4 22.5-9.7 31.1-18.3L487 138.9c28.1-28.1 28.1-73.7.0-101.8L474.9 25C446.8-3.1 401.2-3.1 373.1 25zM88 64C39.4 64 0 103.4.0 152V424c0 48.6 39.4 88 88 88H360c48.6.0 88-39.4 88-88V312c0-13.3-10.7-24-24-24s-24 10.7-24 24V424c0 22.1-17.9 40-40 40H88c-22.1.0-40-17.9-40-40V152c0-22.1 17.9-40 40-40H2e2c13.3.0 24-10.7 24-24s-10.7-24-24-24H88z"/></svg></span></span></a></span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] mr-2" href=/tags/status-update/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">status-update
</span></span></a><a class="relative mt-[0.5rem] mr-2" href=/tags/consensus/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">consensus</span></span></a></div></div><div class="flex author"><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class="flex author author-extra mt-4"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 src=/f1c66b8937bd6938a029cea2fdb21d9b_11706180554726321909_hu_1fd0f9097b9cc146.png><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><a href=https://abundance.build/authors/adlrocha/ class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Alfonso de la Rocha</a><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://linkedin.com/in/adlrocha target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://x.com/adlrocha target=_blank aria-label=X-Twitter rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span></span></a>
<a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/adlrocha target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:me@adlrocha.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>This week I&rsquo;ve gone a bit deeper into the design of the multi-shard Subspace protocol idea which I briefly introduced in
my last update. The protocol is conformed by the following parts:</p><ul><li>Sharded archiving, responsible for creating a global canonical history of the whole system, and of creating the
history records that will eventually become part of farmers&rsquo; plots.</li><li>Sharded plotting, which takes records from the global history and seals them in plots that include segments of the
history of every shard of the system, and that will be used for the farming process.</li><li>And finally, merged farming, which is the protocol responsible for challenging farmer plots, and deriving the
corresponding winning tickets that elect block proposers in specific shards.</li></ul><p>Let me introduce the high-level operation behind each of these sub-protocols, while digging deep in the one that I&rsquo;ve
focused the most on this week: sharded archiving.</p><h2 class="relative group">Adding the pieces together<div id=adding-the-pieces-together class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#adding-the-pieces-together aria-label=Anchor>#</a></span></h2><p>High-level, this is how I am imagining each of these sub-protocols working together:</p><ul><li>Farmers self-assign themselves to whatever shards they want to farm and participate in. At this point, this is a free
choice, but we will build the rewards and incentive model in a way where rational farmers will prioritise farming on
shards that have less competition, thus balancing the power in the system among all shards.</li><li>Farmers in every shard, independently, build the history buffer for the shard with new segments as new blocks are
created and considered final in the shard.</li><li>As new segments are created in a shard, their segment commitments (along with some extra metadata useful for
verification) are committed to the shard&rsquo;s parent so they are propagated up the hierarchy to the root (beacon chain)
where the global history of the system is constructed. This history buffer in the beacon chain includes information
about all segments in all shards (we will discuss briefly how this can be done in the next few sections).</li><li>The way in which farmers assign themselves, i.e. show interest in participating in a shard, is by committing storage
in a specific shard. So in the multi-shard version of the Subspace protocol, space is assigned exclusively to a shard,
and plotting is performed in a way where sectors need to be explicitly linked to a shard.</li><li>For plotting, the selection of pieces for a plot is performed globally by selecting pieces from any shard available in
the global history at the beacon chain. All plots are built with pieces from all shards, and the selection of pieces
is done in a way that is proportional to the amount of space assigned to each shard. So we see that plotting relies on
the construction of this global history in the root of the hierarchy for its operation, but the overall mechanism is
still the same as in the single-shard Subspace protocol.</li><li>Finally, farming is done similarly to how is done in single-chain Subspace protocol, but with the difference that
winning tickets of a plot belong exclusively to the shard where that plot is committed. I will start sharing more
details on how this is done in the next few weeks, but the idea is that shards&rsquo; difficulty, and thus their solution
range, are independent and dynamically adjusted according to the storage committed in the shard and their historical
block generation rate.<ul><li>Even more, we are thinking of a way to allow farmers to &ldquo;merge&rdquo; their plots across shards, so they can farm in
multiple shards at the same time when the power in a shard is low. For this, we expect plots to be primarily
committed to a specific shard, and be assigned to a set of fallback (secondary) shards so when something bad
happens in one of these secondary shards, or the storage (and thus the block farmers will be allowed to generation
rate) falls, farmers secondarily assigned to these shards are allowed to draw winning tickets and vote (or
propose) blocks in these shards.</li></ul></li></ul><h2 class="relative group">Sharded Archiving<div id=sharded-archiving class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#sharded-archiving aria-label=Anchor>#</a></span></h2><p>The operation of sharded archiving is quite straightforward, nodes in a shard are creating segments of their history
that need to be submitted to the beacon chain to make them part of the global history of the system. The first question
that we may ask ourselves is: can we have all shards committing segments commitments (or headers) directly into the
beacon chain as soon as they are created?</p><h3 class="relative group">Can we commit all segment headers to the beacon chain?<div id=can-we-commit-all-segment-headers-to-the-beacon-chain class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#can-we-commit-all-segment-headers-to-the-beacon-chain aria-label=Anchor>#</a></span></h3><p>Let&rsquo;s a assume we have in the order of 1M shards in the system with:</p><ul><li><code>RECORDED_HISTORY_SEGMENT_SIZE = 128MiB</code></li><li><code>WITNESS_SIZE = 48B</code></li><li><code>COMMITMENT_SIZE = 48B</code></li><li><code>BLOCK_SIZE = 4MB</code></li><li><code>BLOCK_TIME = 6s</code></li></ul><p>This translates into:</p><ul><li><code>BLOCKS_PER_SEGMENT = SEGMENT_SIZE / BLOCK_SIZE = 32</code></li><li><code>SEGMENT_GENERATION_TIME_SHARD= (BLOCK_TIME * 32) = 192 seconds</code></li><li><code>SEGMENT_RATE_PER_SLOT = 0.03</code></li></ul><p>Assuming the <code>SegmentHeader</code> with the following struct being committed to the beacon chain:</p><pre tabindex=0><code>V0 {
    /// ShardID
    shard_id: ShardID, (20bits ~ 4Bytes)
    /// Segment index
    segment_index: SegmentIndex, (8 Bytes)
    /// Root of commitments of all records in a segment.
    segment_commitment: SegmentCommitment, (48 Bytes)
    /// Hash of the segment header of the previous segment
    prev_segment_header_hash: Blake3Hash, (32 Bytes)
    /// Last archived block
    last_archived_block: LastArchivedBlock (8 Bytes),
}
</code></pre><p>So if we commit each <code>SegmentHeader</code> we will be committing <code>100 bytes</code> per segment (committing the segment header is the
worst case scenario, we could optimise this and make it more compact by just committing the segment commitment with some
additional metadata, but let&rsquo;s consider the worst case scenario for this exercise).</p><p>If we get all shards committing their segment headers to the beacon chain directly instead of letting segment
commitments flow up through the hierarchy, this means:</p><ul><li><code>AVG_SEGMENTS_PER_SLOT_IN_BEACON = NUM_SHARDS * 0.03 = 30k SEGMENTS / SLOT</code></li><li><code>BYTES_COMMITTED_PER_SLOT_IN_BEACON = AVG_SEGMENTS_PER_SLOT_IN_BEACON * SEGMENT_HEADER_SIZE = 30 * 100 KBYTES = ~3MB</code></li></ul><p>With 4MiB blocks, committing all segments into the beacon chain could actually fit a single block of the beacon chain
with the current rate being considered.</p><p>The number of lower level shards that can be supported by a parent network (and thus the beacon chain) with 4MiB blocks
would be:
<code>NUM_SHARDS = BLOCK_SIZE / (SEGMENT_RATE_PER_SLOT * SEGMENT_HEADER_SIZE) = 4 / (0.03 * 100) = ~1.3M Shards</code></p><p>This is great! It means that with a beacon chain and a single level of shards below committing their segments directly
as soon as they are created we could get to the order of 1M independent shards.</p><h3 class="relative group">But what if we use larger proofs?<div id=but-what-if-we-use-larger-proofs class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#but-what-if-we-use-larger-proofs aria-label=Anchor>#</a></span></h3><p>The back-of-the-envelope calculation above assumes 48B commitments for segments, but what if we want to use a type of
vector commitment for segments that is not KZG and requires bigger proofs? Then we may not be able to commit every
proof, and we may need to rely on several layers of shards forming a hierarchy where parents aggregate segments to
propagate them up and commit them to the global history. On top of this, we also may want to aggregate commitments from
lower levels to minimise the state growth in the beacon chain, but this is a secondary concern at this point.</p><p>I actually explored several solutions for this throughout the week:</p><ul><li>The first one is a bit complex and may have been an overkill in hindsight (thank you Nazar for pointing this out). I
won&rsquo;t jump into the nitty gritty details and will leave this image explaining the high-level here for reference. The
idea was for every parent shard to build a tree with all the segments from their children. With every new segment
created in the parent chain an updated commitment for the tree of children segments is attached to the parent shard
segment along with proofs for all the new segments included in the tree since the last update. In this way, parent
chain segments implicitly propagate relevant information about their children to their upper layers (and eventually
the beacon chain).</li></ul><p align=center><img alt="Hierarchical Verkle Tree of Segments" src=hierarchical_verkle_trees.png></p><ul><li>Nazar rightly pointed out the following: <em>why wait for parent chain segment generation as the cut-off point for
committing segments? Why not batch whatever segments from the children have been submitted to a shard to propagate
them to upper layers as soon as they have been included in a block?</em> And this is the solution that I will consider for
the design. The process is as follows:</li><li>Let&rsquo;s take as an example the tree of shards from the figure above. Shards C and D are generating new segments and
submitting their commitments (or segment headers) to their parent, A.</li><li>These segments are submitted to A by nodes from C and D as transactions that will be included in a block of A.</li><li>As soon as A verifies a block including transactions with segments from C and D, nodes in A will create a &ldquo;super
segment&rdquo; commitment (this is how we are going to call this data structure), that creates a commitment for all the
segments included in the block of A.</li><li>Nodes in A will be periodically creating their own segments and committing them to the beacon chain, as well as the
super segment commitment for the segments from C and D triggered through the submission of segments in A.</li><li>The super segment commitment will be a vector commitment that proves the commitment of segments in the history of A,
and are used to include segments from deeper layer in batch into the global history kept in the beacon chain. Super
segments will be sequenced along with regular segments from immediate children of the beacon chain conforming the
global history of the system with all of the segments created in all shards.</li><li>The purpose of committing these super segments from lower level shards into the beacon chain is to create the global
history of the system. As soon as a super segment is committed in the beacon chain, the underlying history segments
from the shards conforming this super segment are appended to the global history (implicitly sequencing the history of
all shards in the global history of the beacon chain).</li><li>Super segments include additional metadata with information about the segments included in them and any additional
information required for verification (e.g. an aggregate commitment for the individual segments of the super segment).
More details on this will be included in the spec I am currently working on.</li></ul><p>As a reference for folks with deep knowledge of the implementation of the Subspace protocol, the idea is to get a lot of
inspiration to how incremental archiving currently works for the aggregation and submission of segment commitments into
upper layers of the hierarchy.</p><h2 class="relative group">What&rsquo;s next?<div id=whats-next class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#whats-next aria-label=Anchor>#</a></span></h2><p>For next week I am hoping to get a first draft of the spec for sharded archiving with more lower level details of how it
works (and how I imagine the implementation to be). It may be a stretch, but I am also hoping to have a good picture of
how sharded plotting will look like.</p><p>One of the early mandates that I got from Nazar when I started was to identify any potential reasons why a system like
this may not be feasible or may not reach the scale that we are aiming for, and so far I haven&rsquo;t found any, which is
exciting! That being said, please reach out if you see any potential flaws on my reasoning.</p><p>Hope to see you all in the next update!</p></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_blog/2025/2025-04-07-merged-farming.md data-oid-likes=likes_blog/2025/2025-04-07-merged-farming.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/blog/2025-04-07-preparing-for-blockchain/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Preparing for blockchain</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-04-07T00:00:00+00:00>7 April 2025</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/blog/2025-04-08-we-are-building-a-blockchain/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">We are building a blockchain</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-04-08T00:00:00+00:00>8 April 2025</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0 z-10"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400"><a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel="license noopener noreferrer">CC0 1.0 Universal</a></p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer></div></body></html>