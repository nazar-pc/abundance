<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Making RISC-V interpreter faster &#183; Project Abundance</title><meta name=title content="Making RISC-V interpreter faster &#183; Project Abundance"><meta name=description content="Exploration of current limitations of RISC-V interpreter and ideas for making it faster"><meta name=keywords content="status-update,"><link rel=canonical href=https://abundance.build/blog/2026-01-24-making-risc-v-interpreter-faster/><link type=text/css rel=stylesheet href=/css/main.bundle.min.fd951ea54edeca1b6b08c8bbf3c93c284de4c78daf63a71d8016939775734cf68700f1662ed31d870100c676cbe1f65d150635cf368b874c49fc75147bcb04a9.css integrity="sha512-/ZUepU7eyhtrCMi788k8KE3kx42vY6cdgBaTl3VzTPaHAPFmLtMdhwEAxnbL4fZdFQY1zzaLh0xJ/HUUe8sEqQ=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.e4b2d9aece2aa7a740c3ee7a0efc5acf56b204868ab0fb5bba9be32aed1cd0c9262979d98050759068d58144297f74b12ed05b5173cf2df2e6c097a066b984a8.js integrity="sha512-5LLZrs4qp6dAw+56Dvxaz1ayBIaKsPtbupvjKu0c0MkmKXnZgFB1kGjVgUQpf3SxLtBbUXPPLfLmwJegZrmEqA==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://abundance.build/blog/2026-01-24-making-risc-v-interpreter-faster/"><meta property="og:site_name" content="Project Abundance"><meta property="og:title" content="Making RISC-V interpreter faster"><meta property="og:description" content="Exploration of current limitations of RISC-V interpreter and ideas for making it faster"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2026-01-24T00:00:00+00:00"><meta property="article:modified_time" content="2026-01-24T00:00:00+00:00"><meta property="article:tag" content="status-update"><meta name=twitter:card content="summary"><meta name=twitter:title content="Making RISC-V interpreter faster"><meta name=twitter:description content="Exploration of current limitations of RISC-V interpreter and ideas for making it faster"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Blog","name":"Making RISC-V interpreter faster","headline":"Making RISC-V interpreter faster","description":"Exploration of current limitations of RISC-V interpreter and ideas for making it faster","abstract":"\u003cp\u003eIn the \u003ca\n  href=\u0022..\/2025-12-29-contracts-cli-and-risc-v-interpreter\u0022\u003elast update\u003c\/a\u003e I introduced a basic RISC-V interpreter, but its performance was underwhelming, which was to be\nexpected, but still was something that I\u0026rsquo;d like to improve. So since the last update I have implemented infrastructure\nfor measuring performance, did a bunch of refactorings to hopefully make my work reusable by other projects in the\nfuture, and even implemented some performance improvements with a solid idea of what to explore next.\u003c\/p\u003e\n\u003cp\u003eIn the process of doing it I ended up parsing and generating Rust code in \u003cem\u003eboth\u003c\/em\u003e \u003ccode\u003ebuild.rs\u003c\/code\u003e and procedural macros,\nsomething I have never thought I\u0026rsquo;d end up doing, but let\u0026rsquo;s start from the beginning.\u003c\/p\u003e","inLanguage":"en","url":"https:\/\/abundance.build\/blog\/2026-01-24-making-risc-v-interpreter-faster\/","author":{"@type":"Person","name":""},"copyrightYear":"2026","dateCreated":"2026-01-24T00:00:00\u002b00:00","datePublished":"2026-01-24T00:00:00\u002b00:00","dateModified":"2026-01-24T00:00:00\u002b00:00","keywords":["status-update"],"mainEntityOfPage":"true","wordCount":"3507"}]</script><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">Project Abundance</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Making RISC-V interpreter faster</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2026-01-24T00:00:00+00:00>24 January 2026</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">17 mins</span><span class="px-2 text-primary-500">&#183;</span>
<span class=mb-[2px]><a href=https://github.com/nazar-pc/abundance/tree/main/website/main/content/blog/2026/2026-01-24-making-risc-v-interpreter-faster.md class="text-lg hover:text-primary-500" rel="noopener noreferrer" target=_blank title="Edit content"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg height="1em" viewBox="0 0 512 512"><path fill="currentColor" d="M441 58.9 453.1 71c9.4 9.4 9.4 24.6.0 33.9L424 134.1 377.9 88 407 58.9c9.4-9.4 24.6-9.4 33.9.0zM209.8 256.2 344 121.9 390.1 168 255.8 302.2c-2.9 2.9-6.5 5-10.4 6.1L186.9 325l16.7-58.5c1.1-3.9 3.2-7.5 6.1-10.4zM373.1 25 175.8 222.2c-8.7 8.7-15 19.4-18.3 31.1l-28.6 1e2c-2.4 8.4-.1 17.4 6.1 23.6s15.2 8.5 23.6 6.1l1e2-28.6c11.8-3.4 22.5-9.7 31.1-18.3L487 138.9c28.1-28.1 28.1-73.7.0-101.8L474.9 25C446.8-3.1 401.2-3.1 373.1 25zM88 64C39.4 64 0 103.4.0 152V424c0 48.6 39.4 88 88 88H360c48.6.0 88-39.4 88-88V312c0-13.3-10.7-24-24-24s-24 10.7-24 24V424c0 22.1-17.9 40-40 40H88c-22.1.0-40-17.9-40-40V152c0-22.1 17.9-40 40-40H2e2c13.3.0 24-10.7 24-24s-10.7-24-24-24H88z"/></svg></span></span></a></span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] mr-2" href=/tags/status-update/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">status-update</span></span></a></div></div><div class="flex author"><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class="flex author author-extra mt-4"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 src=/3d67cc976284fd62356e2edd8a8dfc49_2651210052118205119_hu_2fd6f6eca7f7083d.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><a href=https://abundance.build/authors/nazar-pc/ class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Nazar Mokrynskyi</a><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://linkedin.com/in/nazarpc target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://x.com/nazarpc target=_blank aria-label=X-Twitter rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span></span></a>
<a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/nazar-pc target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:nazar@mokrynskyi.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>In the <a href=../2025-12-29-contracts-cli-and-risc-v-interpreter>last update</a> I introduced a basic RISC-V interpreter, but its performance was underwhelming, which was to be
expected, but still was something that I&rsquo;d like to improve. So since the last update I have implemented infrastructure
for measuring performance, did a bunch of refactorings to hopefully make my work reusable by other projects in the
future, and even implemented some performance improvements with a solid idea of what to explore next.</p><p>In the process of doing it I ended up parsing and generating Rust code in <em>both</em> <code>build.rs</code> and procedural macros,
something I have never thought I&rsquo;d end up doing, but let&rsquo;s start from the beginning.</p><h2 class="relative group">Baseline performance<div id=baseline-performance class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#baseline-performance aria-label=Anchor>#</a></span></h2><p>As mentioned last time, there was a basic CLI for building a contract. It was possible to run it, but there was no
actual test that runs anything from a contract, and there was no nice programmatic way to even do that.</p><p>The first step was to extract contract building logic from CLI into a library in <a href=https://github.com/nazar-pc/abundance/pull/497 target=_blank>PR 497</a>, which with some follow-up
fixes in <a href=https://github.com/nazar-pc/abundance/pull/499 target=_blank>PR 499</a> and <a href=https://github.com/nazar-pc/abundance/pull/509 target=_blank>PR 509</a> allowed me to implement building, testing, and even benchmarking a basic contract
in <a href=https://github.com/nazar-pc/abundance/pull/510 target=_blank>PR 510</a>. It is a contract that does BLAKE3 hashing and Ed25519 signature verification.</p><p>Why those? I expect them to be used often and, as a reminder, I plan to not have custom domain-specific
precompiles/instructions, so it is important for generic and popular algorithms to perform well, which it clearly didn&rsquo;t
at first:</p><pre tabindex=0><code>file/parse-only         time:   [115.34 µs 117.01 µs 120.17 µs]
                        thrpt:  [8.3215 Kelem/s 8.5463 Kelem/s 8.6702 Kelem/s]
file/parse-with-methods time:   [109.65 µs 109.84 µs 109.99 µs]
                        thrpt:  [9.0920 Kelem/s 9.1046 Kelem/s 9.1198 Kelem/s]
file/iterate-methods    time:   [78.396 ns 78.753 ns 79.699 ns]
                        thrpt:  [12.547 Melem/s 12.698 Melem/s 12.756 Melem/s]

blake3_hash_chunk/native
                        time:   [769.04 ns 769.74 ns 770.31 ns]
                        thrpt:  [1.2380 GiB/s 1.2390 GiB/s 1.2401 GiB/s]
blake3_hash_chunk/interpreter
                        time:   [229.14 µs 230.88 µs 232.84 µs]
                        thrpt:  [4.1942 MiB/s 4.2297 MiB/s 4.2618 MiB/s]

ed25519_verify/native/valid
                        time:   [16.618 µs 16.641 µs 16.692 µs]
                        thrpt:  [59.908 Kelem/s 60.094 Kelem/s 60.176 Kelem/s]
ed25519_verify/native/invalid
                        time:   [16.525 µs 16.554 µs 16.599 µs]
                        thrpt:  [60.245 Kelem/s 60.407 Kelem/s 60.516 Kelem/s]
ed25519_verify/interpreter/valid
                        time:   [6.3310 ms 6.3605 ms 6.4322 ms]
                        thrpt:  [155.47  elem/s 157.22  elem/s 157.95  elem/s]
ed25519_verify/interpreter/invalid
                        time:   [6.0230 ms 6.0487 ms 6.0823 ms]
                        thrpt:  [164.41  elem/s 165.32  elem/s 166.03  elem/s]
</code></pre><p>This is slightly apples to oranges comparing AVX512 assembly BLAKE3 implementation on Zen 4 against a basic interpreter
for RV64EM target, but that is how I measure a success: the ceiling is what the hardware is capable of, and we need to
get close to that with whatever VM ends up being used. I do plan to add vector and crypto extensions in the future,
though.</p><p>So the initial performance gap is around three orders of magnitude.</p><h2 class="relative group">A bit about general approach<div id=a-bit-about-general-approach class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#a-bit-about-general-approach aria-label=Anchor>#</a></span></h2><p>When writing code, I&rsquo;m trying to make it look &ldquo;obviously correct&rdquo; whenever possible, especially when complex concepts
are involved. Of course, the domain which I&rsquo;m working in is inherently complex, so it may not be <em>that</em> obvious in
absolute terms, but I hope you at least get the idea of what I&rsquo;m trying to say here.</p><p>Going back to the topic of RISC-V interpreter, my initial approach was to have an instruction decoder and interpreter
separately. Decoder outputs an enum, and then the interpreter matches on decoded instructions and executes them. I even
extracted M extension from RV64 base in <a href=https://github.com/nazar-pc/abundance/pull/511 target=_blank>PR 511</a> and used composition with a base instruction set to allow more
flexibility and being able to test various permutations quickly, which allowed me to add B extension (including optional
Zbc) in <a href=https://github.com/nazar-pc/abundance/pull/512 target=_blank>PR 512</a> shortly after that. Zbc extension was further optimized with platform-specific intrinsics on
x86-64/aarch64/RV64 in <a href=https://github.com/nazar-pc/abundance/pull/518 target=_blank>PR 518</a>.</p><p>That simplicity is great for reviewing and understanding code. For example, here is what decoding and execution of
Zbs instructions looks like in the current version of the codebase:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[derive(Debug, Clone, Copy, PartialEq, Eq)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>enum</span> <span class=nc>Rv64ZbsInstruction</span><span class=o>&lt;</span><span class=n>Reg</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Single-Bit Set
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>Bset</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>rs2</span>: <span class=nc>Reg</span><span class=w> </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Bseti</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>shamt</span>: <span class=kt>u8</span> <span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Single-Bit Clear
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>Bclr</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>rs2</span>: <span class=nc>Reg</span><span class=w> </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Bclri</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>shamt</span>: <span class=kt>u8</span> <span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Single-Bit Invert
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>Binv</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>rs2</span>: <span class=nc>Reg</span><span class=w> </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Binvi</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>shamt</span>: <span class=kt>u8</span> <span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Single-Bit Extract
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>Bext</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>rs2</span>: <span class=nc>Reg</span><span class=w> </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Bexti</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>shamt</span>: <span class=kt>u8</span> <span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=o>&lt;</span><span class=n>Reg</span><span class=o>&gt;</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>Instruction</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Rv64ZbsInstruction</span><span class=o>&lt;</span><span class=n>Reg</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Reg</span>: <span class=p>[</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=p>]</span><span class=w> </span><span class=n>Register</span><span class=o>&lt;</span><span class=n>Type</span><span class=o>=</span><span class=kt>u64</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>type</span> <span class=nc>Reg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Reg</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[inline(always)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>try_decode</span><span class=p>(</span><span class=n>instruction</span>: <span class=kt>u32</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Option</span><span class=o>&lt;</span><span class=bp>Self</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>instruction</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mb>0b111_1111</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>rd_bits</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>instruction</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>7</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x1f</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>funct3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>instruction</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>12</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mb>0b111</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>rs1_bits</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>instruction</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>15</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x1f</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>rs2_bits</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>instruction</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>20</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x1f</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>shamt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>instruction</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>20</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x3f</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>funct7</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>instruction</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>25</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mb>0b111_1111</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>funct6</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>instruction</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>26</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mb>0b11_1111</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// R-type instructions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=mb>0b0110011</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>rd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Reg</span>::<span class=n>from_bits</span><span class=p>(</span><span class=n>rd_bits</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>rs1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Reg</span>::<span class=n>from_bits</span><span class=p>(</span><span class=n>rs1_bits</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>rs2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Reg</span>::<span class=n>from_bits</span><span class=p>(</span><span class=n>rs2_bits</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>match</span><span class=w> </span><span class=p>(</span><span class=n>funct3</span><span class=p>,</span><span class=w> </span><span class=n>funct7</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>(</span><span class=mb>0b001</span><span class=p>,</span><span class=w> </span><span class=mb>0b0010100</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=bp>Self</span>::<span class=n>Bset</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span><span class=p>,</span><span class=w> </span><span class=n>rs2</span><span class=w> </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>(</span><span class=mb>0b001</span><span class=p>,</span><span class=w> </span><span class=mb>0b0100100</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=bp>Self</span>::<span class=n>Bclr</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span><span class=p>,</span><span class=w> </span><span class=n>rs2</span><span class=w> </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>(</span><span class=mb>0b001</span><span class=p>,</span><span class=w> </span><span class=mb>0b0110100</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=bp>Self</span>::<span class=n>Binv</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span><span class=p>,</span><span class=w> </span><span class=n>rs2</span><span class=w> </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>(</span><span class=mb>0b101</span><span class=p>,</span><span class=w> </span><span class=mb>0b0100100</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=bp>Self</span>::<span class=n>Bext</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span><span class=p>,</span><span class=w> </span><span class=n>rs2</span><span class=w> </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>None</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// I-type instructions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=mb>0b0010011</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>rd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Reg</span>::<span class=n>from_bits</span><span class=p>(</span><span class=n>rd_bits</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>rs1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Reg</span>::<span class=n>from_bits</span><span class=p>(</span><span class=n>rs1_bits</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>match</span><span class=w> </span><span class=p>(</span><span class=n>funct3</span><span class=p>,</span><span class=w> </span><span class=n>funct6</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>(</span><span class=mb>0b001</span><span class=p>,</span><span class=w> </span><span class=mb>0b001010</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=bp>Self</span>::<span class=n>Bseti</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span><span class=p>,</span><span class=w> </span><span class=n>shamt</span><span class=w> </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>(</span><span class=mb>0b001</span><span class=p>,</span><span class=w> </span><span class=mb>0b010010</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=bp>Self</span>::<span class=n>Bclri</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span><span class=p>,</span><span class=w> </span><span class=n>shamt</span><span class=w> </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>(</span><span class=mb>0b001</span><span class=p>,</span><span class=w> </span><span class=mb>0b011010</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=bp>Self</span>::<span class=n>Binvi</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span><span class=p>,</span><span class=w> </span><span class=n>shamt</span><span class=w> </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>(</span><span class=mb>0b101</span><span class=p>,</span><span class=w> </span><span class=mb>0b010010</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=bp>Self</span>::<span class=n>Bexti</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span><span class=p>,</span><span class=w> </span><span class=n>shamt</span><span class=w> </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>None</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>None</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[inline(always)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>alignment</span><span class=p>()</span><span class=w> </span>-&gt; <span class=kt>u8</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>size_of</span>::<span class=o>&lt;</span><span class=kt>u32</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[inline(always)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>size</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>u8</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>size_of</span>::<span class=o>&lt;</span><span class=kt>u32</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>impl</span><span class=o>&lt;</span><span class=n>Reg</span><span class=p>,</span><span class=w> </span><span class=n>Memory</span><span class=p>,</span><span class=w> </span><span class=no>PC</span><span class=p>,</span><span class=w> </span><span class=n>InstructionHandler</span><span class=p>,</span><span class=w> </span><span class=n>CustomError</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ExecutableInstruction</span><span class=o>&lt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Rv64InterpreterState</span><span class=o>&lt;</span><span class=n>Reg</span><span class=p>,</span><span class=w> </span><span class=n>Memory</span><span class=p>,</span><span class=w> </span><span class=no>PC</span><span class=p>,</span><span class=w> </span><span class=n>InstructionHandler</span><span class=p>,</span><span class=w> </span><span class=n>CustomError</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CustomError</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&gt;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Rv64ZbsInstruction</span><span class=o>&lt;</span><span class=n>Reg</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Reg</span>: <span class=nc>Register</span><span class=o>&lt;</span><span class=n>Type</span><span class=o>=</span><span class=kt>u64</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>[();</span><span class=w> </span><span class=n>Reg</span>::<span class=n>N</span><span class=p>]</span>:<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[inline(always)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>execute</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>state</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Rv64InterpreterState</span><span class=o>&lt;</span><span class=n>Reg</span><span class=p>,</span><span class=w> </span><span class=n>Memory</span><span class=p>,</span><span class=w> </span><span class=no>PC</span><span class=p>,</span><span class=w> </span><span class=n>InstructionHandler</span><span class=p>,</span><span class=w> </span><span class=n>CustomError</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>ControlFlow</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionError</span><span class=o>&lt;</span><span class=n>Reg</span>::<span class=n>Type</span><span class=p>,</span><span class=w> </span><span class=bp>Self</span><span class=p>,</span><span class=w> </span><span class=n>CustomError</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=bp>self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>Self</span>::<span class=n>Bset</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span><span class=p>,</span><span class=w> </span><span class=n>rs2</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Only the bottom 6 bits for RV64
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>rs2</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x3f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>rs1</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=k>u64</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>index</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>Self</span>::<span class=n>Bseti</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span><span class=p>,</span><span class=w> </span><span class=n>shamt</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shamt</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>rs1</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=k>u64</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>index</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>Self</span>::<span class=n>Bclr</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span><span class=p>,</span><span class=w> </span><span class=n>rs2</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>rs2</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x3f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>rs1</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=o>!</span><span class=p>(</span><span class=mi>1</span><span class=k>u64</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>index</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>Self</span>::<span class=n>Bclri</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span><span class=p>,</span><span class=w> </span><span class=n>shamt</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shamt</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>rs1</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=o>!</span><span class=p>(</span><span class=mi>1</span><span class=k>u64</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>index</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>Self</span>::<span class=n>Binv</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span><span class=p>,</span><span class=w> </span><span class=n>rs2</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>rs2</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x3f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>rs1</span><span class=p>)</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=k>u64</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>index</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>Self</span>::<span class=n>Binvi</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span><span class=p>,</span><span class=w> </span><span class=n>shamt</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shamt</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>rs1</span><span class=p>)</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=k>u64</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>index</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>Self</span>::<span class=n>Bext</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span><span class=p>,</span><span class=w> </span><span class=n>rs2</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>rs2</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x3f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>rs1</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>index</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>Self</span>::<span class=n>Bexti</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span><span class=p>,</span><span class=w> </span><span class=n>shamt</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shamt</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>rs1</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>index</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>ControlFlow</span>::<span class=n>Continue</span><span class=p>(()))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>But that was not so great for performance since in addition to branches during instruction decoding, another match (or
several when composition of multiple instructions is used) needs to be done on something that was just decoded.</p><p>You may also notice quite a few generics, that is because interpreter and register/instruction abstractions are generic
over both the base instruction set (RV32/RV64) and the number of registers (E extension, so RV32I/RV64I vs.
RV32E/RV64E). While there is no instruction decoding or execution implemented for RV32 base yet, it should technically
work. Interpreter is also generic over memory, instruction decoder, and handling of syscalls, which is why I&rsquo;m hoping
the work I&rsquo;m doing will be useful for the broader Rust ecosystem since I have not seen something that looks exactly like
this yet. Also, neither instruction decoder nor interpreter are in any way specific or dependent on anything
Abundance-specific, only generic reusable code.</p><p>Of course, I&rsquo;m heavily using Rust Nightly features, so it only runs on Nightly and will stay that way for some time.</p><h2 class="relative group">Eager instruction decoding<div id=eager-instruction-decoding class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#eager-instruction-decoding aria-label=Anchor>#</a></span></h2><p>The first obvious thing was when I compared the number of instructions in the contract with the number of instructions
executed when doing BLAKE3 hashing and Ed25519 signature verification. Turns out, due to loops in the code, the number
of instructions executed is far larger, so it makes sense to decode the whole contract upfront and then simply fetch
pre-decoded instructions. That was immediately much better, as can be seen in benchmark results:</p><pre tabindex=0><code>file/decode-instructions
                        time:   [112.00 µs 113.21 µs 115.70 µs]
                        thrpt:  [8.6431 Kelem/s 8.8333 Kelem/s 8.9288 Kelem/s]

blake3_hash_chunk/interpreter/lazy
                        time:   [200.31 µs 211.64 µs 217.33 µs]
                        thrpt:  [4.4935 MiB/s 4.6143 MiB/s 4.8753 MiB/s]
blake3_hash_chunk/interpreter/eager
                        time:   [81.048 µs 86.829 µs 91.780 µs]
                        thrpt:  [10.640 MiB/s 11.247 MiB/s 12.049 MiB/s]

ed25519_verify/interpreter/lazy
                        time:   [6.7690 ms 6.8320 ms 6.8638 ms]
                        thrpt:  [145.69  elem/s 146.37  elem/s 147.73  elem/s]
ed25519_verify/interpreter/eager
                        time:   [2.3935 ms 2.4013 ms 2.4121 ms]
                        thrpt:  [414.58  elem/s 416.44  elem/s 417.80  elem/s]
</code></pre><p>Though it was still very far from native, despite however flawed that comparison is to begin with.</p><h2 class="relative group">Spatial locality of popular instructions<div id=spatial-locality-of-popular-instructions class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#spatial-locality-of-popular-instructions aria-label=Anchor>#</a></span></h2><p>While I&rsquo;ve done some more improvements like skipping bounds checks during instruction fetching in most cases in <a href=https://github.com/nazar-pc/abundance/pull/517 target=_blank>PR 517</a>
and combined some shared fields in the same data structure in <a href=https://github.com/nazar-pc/abundance/pull/520 target=_blank>PR 520</a>, none of it allowed closing the gap
substantially.</p><p>What I explored then was which instructions are even included in the contract&rsquo;s binary. Turned out, very few relatively
to the available set and with a heavy skew towards a small minority:</p><pre tabindex=0><code>2637 ld         80 andn       3 bseti
2086 sd         59 sh3add     3 slti
1983 add        46 andi       3 addiw
1266 addi       26 rev8       2 sextb
 974 xor        26 bne        2 slt
 736 rori       23 lui        2 sh
 689 srli       18 lb         2 lh
 593 or         17 beq        2 blt
 561 and        15 srai       1 bexti
 548 slli       15 jal        1 bclri
 526 lbu        14 bltu       1 unimp
 393 auipc      11 bgeu
 318 jalr       10 sw
 260 sb         10 lw
 224 roriw       9 sltiu
 169 sub         7 subw
 127 sltu        5 xori
 121 mulhu       4 sh2add
 120 mul         4 srl
 106 sh1add      4 sll
</code></pre><p>And surely enough, after doing some crude refactoring locally and moving enum variants and interpreter implementation of
popular instructions closer together, I was able to observe double-digit percentage performance improvement.</p><h2 class="relative group">Procedural macros alone are not enough<div id=procedural-macros-alone-are-not-enough class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#procedural-macros-alone-are-not-enough aria-label=Anchor>#</a></span></h2><p>The problem is, I&rsquo;d really like to keep instruction decoding and execution the way it is. It is very readable and not
tied to any project, it is pretty much what you&rsquo;d write if you read the spec. But it is bad for performance, so what do
we do? The answer, often, is procedural macros.</p><p>My intial plan was to parse enum with instructions and then generate a <code>macro_rules</code> for each variant, so I can
recombine them something like this:</p><pre tabindex=0><code>#[instruction]
enum Custom {
    rv64_add!(),
    rv64_sub!(),
}
</code></pre><p>I tried a few variations of this, but ultimately due to the order of macro expansion, those <code>rv64_add!()</code> end up being
expanded last and Rust doesn&rsquo;t allow them to be placed in that position. I&rsquo;ve spent some time thinking about something
that looks like Rust and concluded that it can&rsquo;t be done with procedural macro alone.</p><p>Thankfully, David Tolnay comes to the rescue again with <a href=https://crates.io/crates/syn target=_blank>syn</a> and <a href=https://crates.io/crates/quote target=_blank>quote</a> that do not require to be used within
procedural macros. So the new plan was to parse all files from <code>build.rs</code>, generate necessary replacements bits of code
in separate files, which procedural macro will then simply replace original definitions with. And since I want to be
able to still do composition of various extensions, <code>build.rs</code> can <a href=https://doc.rust-lang.org/cargo/reference/build-scripts.html#the-links-manifest-key target=_blank>emit metadata</a> with dependencies and locations of
generated files that dependant crates can consume and/or re-export further.</p><p>In the simplest case, slapping <code>#[instruction]</code> on instruction definition and decoding implementation and
<code>#[instruction_execution]</code> on execution implementation is enough to parse and generate necessary metadata:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=sd>/// RISC-V RV64 instruction
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=cp>#[instruction]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Debug, Clone, Copy, PartialEq, Eq)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>enum</span> <span class=nc>Rv64Instruction</span><span class=o>&lt;</span><span class=n>Reg</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Add</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span>: <span class=nc>Reg</span><span class=p>,</span><span class=w> </span><span class=n>rs2</span>: <span class=nc>Reg</span><span class=w> </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ,,,
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[instruction]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=o>&lt;</span><span class=n>Reg</span><span class=o>&gt;</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>Instruction</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Rv64Instruction</span><span class=o>&lt;</span><span class=n>Reg</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Reg</span>: <span class=p>[</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=p>]</span><span class=w> </span><span class=n>Register</span><span class=o>&lt;</span><span class=n>Type</span><span class=o>=</span><span class=kt>u64</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>type</span> <span class=nc>Reg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Reg</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[inline(always)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>try_decode</span><span class=p>(</span><span class=n>instruction</span>: <span class=kt>u32</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Option</span><span class=o>&lt;</span><span class=bp>Self</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[instruction_execution]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=o>&lt;</span><span class=n>Reg</span><span class=p>,</span><span class=w> </span><span class=n>Memory</span><span class=p>,</span><span class=w> </span><span class=no>PC</span><span class=p>,</span><span class=w> </span><span class=n>InstructionHandler</span><span class=p>,</span><span class=w> </span><span class=n>CustomError</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ExecutableInstruction</span><span class=o>&lt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Rv64InterpreterState</span><span class=o>&lt;</span><span class=n>Reg</span><span class=p>,</span><span class=w> </span><span class=n>Memory</span><span class=p>,</span><span class=w> </span><span class=no>PC</span><span class=p>,</span><span class=w> </span><span class=n>InstructionHandler</span><span class=p>,</span><span class=w> </span><span class=n>CustomError</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CustomError</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&gt;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Rv64Instruction</span><span class=o>&lt;</span><span class=n>Reg</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Reg</span>: <span class=nc>Register</span><span class=o>&lt;</span><span class=n>Type</span><span class=o>=</span><span class=kt>u64</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>[();</span><span class=w> </span><span class=n>Reg</span>::<span class=n>N</span><span class=p>]</span>:<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Memory</span>: <span class=nc>VirtualMemory</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=no>PC</span>: <span class=nc>ProgramCounter</span><span class=o>&lt;</span><span class=n>Reg</span>::<span class=n>Type</span><span class=p>,</span><span class=w> </span><span class=n>Memory</span><span class=p>,</span><span class=w> </span><span class=n>CustomError</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>InstructionHandler</span>: <span class=nc>Rv64SystemInstructionHandler</span><span class=o>&lt;</span><span class=n>Reg</span><span class=p>,</span><span class=w> </span><span class=n>Memory</span><span class=p>,</span><span class=w> </span><span class=no>PC</span><span class=p>,</span><span class=w> </span><span class=n>CustomError</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[inline(always)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>execute</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>state</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Rv64InterpreterState</span><span class=o>&lt;</span><span class=n>Reg</span><span class=p>,</span><span class=w> </span><span class=n>Memory</span><span class=p>,</span><span class=w> </span><span class=no>PC</span><span class=p>,</span><span class=w> </span><span class=n>InstructionHandler</span><span class=p>,</span><span class=w> </span><span class=n>CustomError</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>ControlFlow</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionError</span><span class=o>&lt;</span><span class=n>Reg</span>::<span class=n>Type</span><span class=p>,</span><span class=w> </span><span class=bp>Self</span><span class=p>,</span><span class=w> </span><span class=n>CustomError</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=bp>self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>Self</span>::<span class=n>Add</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>rs1</span><span class=p>,</span><span class=w> </span><span class=n>rs2</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>rs1</span><span class=p>).</span><span class=n>wrapping_add</span><span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>rs2</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>state</span><span class=p>.</span><span class=n>regs</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=n>rd</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>And then, of course, additional call needs to be made in <code>build.rs</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>ab_riscv_macros</span>::<span class=n>process_instruction_macros</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>error</span>::<span class=n>Error</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=nb>Box</span><span class=o>&lt;</span><span class=k>dyn</span><span class=w> </span><span class=n>Error</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>process_instruction_macros</span><span class=p>()</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>And for all this to be reusable by dependencies it, <code>package.links</code> needs to be added to <code>Cargo.toml</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>package</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;ab-contract-file&#34;</span>
</span></span><span class=line><span class=cl><span class=c># ...</span>
</span></span><span class=line><span class=cl><span class=nx>links</span> <span class=p>=</span> <span class=s2>&#34;ab-contract-file&#34;</span>
</span></span></code></pre></div><p>But the most interesting thing is that this makes it possible to split, merge, reorder, or partially skipping
instructions. As I mentioned earlier, some instructions are more popular than others:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=sd>/// Instructions that are the most popular among contracts
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=cp>#[instruction(
</span></span></span><span class=line><span class=cl><span class=cp>    reorder = [
</span></span></span><span class=line><span class=cl><span class=cp>        Ld, Sd, Add, Addi, Xor, Rori, Srli, Or, And, Slli, Lbu, Auipc, Jalr, Sb, Roriw, Sub, Sltu,
</span></span></span><span class=line><span class=cl><span class=cp>        Mulhu, Mul, Sh1add,
</span></span></span><span class=line><span class=cl><span class=cp>    ],
</span></span></span><span class=line><span class=cl><span class=cp>    ignore = [
</span></span></span><span class=line><span class=cl><span class=cp>        Rv64Instruction,
</span></span></span><span class=line><span class=cl><span class=cp>        Rv64MInstruction,
</span></span></span><span class=line><span class=cl><span class=cp>        Rv64BInstruction,
</span></span></span><span class=line><span class=cl><span class=cp>        Rv64ZbcInstruction,
</span></span></span><span class=line><span class=cl><span class=cp>    ],
</span></span></span><span class=line><span class=cl><span class=cp>    inherit = [
</span></span></span><span class=line><span class=cl><span class=cp>        Rv64Instruction,
</span></span></span><span class=line><span class=cl><span class=cp>        Rv64MInstruction,
</span></span></span><span class=line><span class=cl><span class=cp>        Rv64BInstruction,
</span></span></span><span class=line><span class=cl><span class=cp>        Rv64ZbcInstruction,
</span></span></span><span class=line><span class=cl><span class=cp>    ],
</span></span></span><span class=line><span class=cl><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Debug, Clone, Copy, PartialEq, Eq)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>enum</span> <span class=nc>PopularInstruction</span><span class=o>&lt;</span><span class=n>Reg</span><span class=o>&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Instructions that are less popular among contracts
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=cp>#[instruction(
</span></span></span><span class=line><span class=cl><span class=cp>    ignore = [PopularInstruction, Fence, Ecall],
</span></span></span><span class=line><span class=cl><span class=cp>    inherit = [
</span></span></span><span class=line><span class=cl><span class=cp>        Rv64Instruction,
</span></span></span><span class=line><span class=cl><span class=cp>        Rv64MInstruction,
</span></span></span><span class=line><span class=cl><span class=cp>        Rv64BInstruction,
</span></span></span><span class=line><span class=cl><span class=cp>        Rv64ZbcInstruction,
</span></span></span><span class=line><span class=cl><span class=cp>    ],
</span></span></span><span class=line><span class=cl><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Debug, Clone, Copy, PartialEq, Eq)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>enum</span> <span class=nc>NotPopularInstruction</span><span class=o>&lt;</span><span class=n>Reg</span><span class=o>&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span></code></pre></div><p>With this, we get two enums, where all instructions are reordered and flattened in both definition and implementation.
While at it, I also ignored some instructions that contracts are not supposed to contain like <code>Fence</code> and <code>Ecall</code>. And
surely enough, performance improved again significantly; even instruction decoding became much faster:</p><pre tabindex=0><code>file/parse-only         time:   [83.585 µs 85.928 µs 88.935 µs]
                        thrpt:  [11.244 Kelem/s 11.638 Kelem/s 11.964 Kelem/s]
                 change:
                        time:   [−28.603% −27.030% −25.232%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+33.747% +37.042% +40.061%]
file/parse-with-methods time:   [83.389 µs 84.704 µs 86.508 µs]
                        thrpt:  [11.560 Kelem/s 11.806 Kelem/s 11.992 Kelem/s]
                 change:
                        time:   [−29.627% −28.854% −27.861%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+38.621% +40.555% +42.100%]
file/decode-instructions
                        time:   [91.852 µs 92.057 µs 92.373 µs]
                        thrpt:  [10.826 Kelem/s 10.863 Kelem/s 10.887 Kelem/s]
                 change:
                        time:   [−11.233% −9.3143% −7.4060%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+7.9983% +10.271% +12.655%]

blake3_hash_chunk/native
                        time:   [769.88 ns 770.34 ns 770.86 ns]
                        thrpt:  [1.2372 GiB/s 1.2380 GiB/s 1.2387 GiB/s]
blake3_hash_chunk/interpreter/lazy
                        time:   [123.31 µs 125.63 µs 131.19 µs]
                        thrpt:  [7.4437 MiB/s 7.7734 MiB/s 7.9194 MiB/s]
                 change:
                        time:   [−40.658% −38.304% −35.395%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+54.786% +62.086% +68.513%]
blake3_hash_chunk/interpreter/eager
                        time:   [58.122 µs 60.115 µs 63.763 µs]
                        thrpt:  [15.316 MiB/s 16.245 MiB/s 16.802 MiB/s]
                 change:
                        time:   [−10.095% −5.8940% −2.0291%] (p = 0.01 &lt; 0.05)
                        thrpt:  [+2.0711% +6.2632% +11.229%]

ed25519_verify/native   time:   [16.581 µs 16.625 µs 16.743 µs]
                        thrpt:  [59.727 Kelem/s 60.150 Kelem/s 60.310 Kelem/s]
ed25519_verify/interpreter/lazy
                        time:   [4.4544 ms 4.5550 ms 4.7086 ms]
                        thrpt:  [212.38  elem/s 219.54  elem/s 224.50  elem/s]
                 change:
                        time:   [−35.284% −33.827% −32.133%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+47.347% +51.119% +54.522%]
ed25519_verify/interpreter/eager
                        time:   [2.1032 ms 2.1154 ms 2.1251 ms]
                        thrpt:  [470.56  elem/s 472.71  elem/s 475.48  elem/s]
                 change:
                        time:   [−10.465% −8.8065% −7.3122%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+7.8891% +9.6570% +11.688%]
</code></pre><p>Still about two orders of magnitude slower, but it is not three, progress!</p><p>Of course, above enums are defined downstream of generic crates since they are specific to contracts, but now anyone can
do similar things without massive copy-pasting and with quick iteration speed.</p><p>All this was implemented in <a href=https://github.com/nazar-pc/abundance/pull/531 target=_blank>PR 531</a>. As a bonus, it also <a href=https://github.com/nazar-pc/abundance/pull/531/files#diff-8f60208ee893d4d5718247f38061b94263f759d50448245ca9e0a1379b9d1c3e target=_blank>has code pre- and post-processors</a> because it turns out <code>syn</code>
only supports stable Rust syntax and I used very much unstable and even incomplete Nightly features, so I had to replace
things like <code>impl const Instruction</code> with <code>impl cnst::Instruction</code> and <code>Reg: [const] Register</code> with
<code>Reg: BRCONST+Register</code> just to keep it syntaxically valid in stable Rust for <code>syn</code> to parse successfully and then
reverting it back before writing to files. You can find this hack <a href=https://github.com/nazar-pc/abundance/pull/531/files#diff-8f60208ee893d4d5718247f38061b94263f759d50448245ca9e0a1379b9d1c3e target=_blank>here</a>.</p><p>Overall, I&rsquo;m quite happy with the way it turned out, the biggest drawback so far is developer experience since going to
definition of these enums in IntelliJ now jumps to generated files, and due to the order of macro expansion and other
compile-time limitations, I don&rsquo;t think there is much that can be done with it for now.</p><h2 class="relative group">Next steps for improving performance<div id=next-steps-for-improving-performance class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#next-steps-for-improving-performance aria-label=Anchor>#</a></span></h2><p>The workflow still follows the pattern of separate instruction decoding and execution. Now that I have the machinery
for parsing and generating code while resolving dependencies, it should be possible to combine instruction decoding and
execution in lazy case to skip the extra <code>match</code> before execution. It should also be possible to extract execution of
each enum variant into a separate generated function and then store pointers to those functions alongside enum payload,
which opens the possibility for jump-dispatch or indirect threading.</p><p>It is still early for me, but I&rsquo;m optimistic it&rsquo;ll be possible to close the gap of another magnitude order with that,
some instruction fusion and adding support for vector extension. While it wouldn&rsquo;t be possible to take advantage of
vector extension very easily in Nightly Rust directly until <a href=https://github.com/rust-lang/rust/issues/133146 target=_blank>scalable vectors for RISC-V</a> are supported (thankfully,
there was a push last year for <a href=https://github.com/rust-lang/rust-project-goals/issues/270 target=_blank>SVE/SME on aarch64</a>, which RISC-V will benefit from too), LLVM auto-vectorization is
still helpful. I tried compiling contracts with <code>V</code> extension and can confirm the code is significantly more compact,
meaning LLVM is doing something implicitly.</p><p>If you have other ideas or would like to work on it, please reach out.</p><h2 class="relative group">Infrastructure improvements<div id=infrastructure-improvements class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#infrastructure-improvements aria-label=Anchor>#</a></span></h2><p>In <a href=https://github.com/nazar-pc/abundance/pull/528 target=_blank>PR 528</a> and <a href=https://github.com/nazar-pc/abundance/pull/529 target=_blank>PR 529</a> I introduced CI checks for RISC-V targets (primarily Clippy and Miri).</p><p>In <a href=https://github.com/nazar-pc/abundance/pull/534 target=_blank>PR 534</a> I did a substantial amount of work on RISC-V compliance testing by parsing test cases from files in included
in <a href=https://github.com/riscv-non-isa/riscv-arch-test target=_blank>riscv-non-isa/riscv-arch-test</a>. While I didn&rsquo;t discover any implementation issues so far, I sleep better knowing
that test coverage has improved. It is only for interpreter, though. I&rsquo;m still looking for reasonably usable test
vectors for instruction decoding that I can take advantage of. If you know about any, please share with me. In the
process of working on this, it turned out the whole B extension had broken data for many years in that repo, so only
RV64I (RV64E is missing in the repo) and M extension for RV64 is currently being tested.</p><h2 class="relative group">Improvements to contracts ABI<div id=improvements-to-contracts-abi class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#improvements-to-contracts-abi aria-label=Anchor>#</a></span></h2><p>Well, that was a long update already, but it turns out working with contracts was a bit more unpleasant than expected,
so I&rsquo;ve done some work there as well to improve the status quo.</p><p>First, with <a href=https://github.com/nazar-pc/abundance/pull/498 target=_blank>PR 498</a> it is now possible to not only write, but also read <code>#[output]</code> values. There were a few bugs found
as well, which I fixed with additional test cases added accordingly. This made calling RISC-V contracts for benchmarking
purposes directly much more pleasant. In fact, I&rsquo;m now on track to removing the need to specify <code>#[input]</code> and
<code>#[output]</code> on contract method arguments, which I think will be a positive change, especially for the simplest cases.
The other arguments like slots will still need annotations since there is no way to infer them.</p><p>And I changed ABI in <a href=https://github.com/nazar-pc/abundance/pull/508 target=_blank>PR 508</a>, which I think makes things simpler to explain and simpler in the implementation and
removes the need to use null pointers in some cases, which bothered me for a while. I do not see the need to change ABI
any further from now on, but we&rsquo;ll see if something else gets discovered to change my mind.</p><h2 class="relative group">Upcoming plans<div id=upcoming-plans class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#upcoming-plans aria-label=Anchor>#</a></span></h2><p>With that unexpectedly lengthy update out of the way, I think I&rsquo;ll pause with RISC-V changes for a bit. It feels more
and more like a grind rather than something exciting after working with it for a few weeks. While I didn&rsquo;t wrap the
interpreter into the execution environment yet, it shouldn&rsquo;t take too long once I actually need it with the refactoring
I have done recently.</p><p>I&rsquo;ll probably focus on sharding for a bit again, after all, the global history and shard confirmation still lacks
implementation and has some open design questions I need to address before intermediate and leaf shards can be
introduced and for the whole thing to look like something more than another typical basic blockchain.</p><p>I&rsquo;ll be happy to chat about anything you&rsquo;ve read here on <a href=https://abundance.zulipchat.com/ target=_blank>Zulip</a> and will be back with another update once I have more
to share about the progress.</p></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_blog/2026/2026-01-24-making-risc-v-interpreter-faster.md data-oid-likes=likes_blog/2026/2026-01-24-making-risc-v-interpreter-faster.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/blog/2026-01-01-a-year-of-abundance/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">A year of Abundance</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2026-01-01T00:00:00+00:00>1 January 2026</time>
</span></span></a></span><span></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0 z-10"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400"><a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel="license noopener noreferrer">CC0 1.0 Universal</a></p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer></div></body></html>